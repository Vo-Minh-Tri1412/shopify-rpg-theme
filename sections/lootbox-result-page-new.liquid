<script>
// --- CẤU HÌNH ---
const STORAGE_KEY = 'rpg_lootbox_history';

document.addEventListener('DOMContentLoaded', function() {
  initPage();
});

function getUrlParams() {
  const url = window.location.href;
  const getParam = (name) => {
    const regex = new RegExp('[?&]' + name + '=([^&]*)');
    const res = regex.exec(url);
    return res ? decodeURIComponent(res[1]) : null;
  };
  return { token: getParam('token'), product: getParam('product'), auto: getParam('open_result') };
}

// Hàm giả lập Random dựa trên Seed (Mã đơn hàng)
// Cùng 1 mã đơn hàng -> Luôn ra cùng 1 số ngẫu nhiên
function seededRandom(seed) {
  var x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
}

async function initPage() {
  const params = getUrlParams();
  
  // 1. Kiểm tra lịch sử trên máy này
  const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  
  // Nếu đã mở trên máy này rồi -> Hiện thẳng kết quả cũ (hoặc màn hình Used)
  if (params.token && history[params.token]) {
    showUsedState(history[params.token]); // Hàm hiển thị lại kết quả đã mở
    return;
  }

  // 2. Load ảnh sản phẩm
  if(params.product) {
    try {
      const res = await fetch('/products/' + params.product + '.js');
      const product = await res.json();
      document.getElementById('chest-img').src = product.featured_image;
      document.getElementById('product-name').innerText = product.title;
      window.currentHandle = params.product;
    } catch(e) {}
  }

  // 3. Auto mở nếu link từ checkout
  if(params.auto === 'true' && params.token) {
    setTimeout(() => triggerOpenSequence(), 1000);
  }
}

async function triggerOpenSequence() {
  const params = getUrlParams();
  const token = params.token || '0'; // Mã đơn hàng
  const seed = parseInt(token.replace(/\D/g, '')) || Date.now(); // Lấy số từ mã đơn hàng làm hạt giống

  // UI Animation
  const chest = document.getElementById('chest-img');
  const btn = document.getElementById('btn-open');
  btn.style.display = 'none';
  chest.classList.add('shaking');
  
  // Lấy Loot Table
  let lootTable = [];
  if (window.currentHandle) {
    try {
      const res = await fetch('/products/' + window.currentHandle + '?section_id=lootbox-data');
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const dataEl = doc.getElementById('loot-table-data');
      if (dataEl) lootTable = JSON.parse(dataEl.textContent);
    } catch(e) {}
  }
  if(!lootTable.length) lootTable = [{ name: 'Mystery Item', image: '', chance: 100 }];
  
  // --- QUAN TRỌNG: CHỐNG REROLL ---
  // Thay vì getWeightedRandom thường, ta truyền Seed vào
  const reward = getSeededWeightedRandom(lootTable, seed);
  const code = generateSeededCode(seed);

  // Lưu kết quả ngay lập tức vào LocalStorage
  const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  history[token] = {
    name: reward.name,
    image: reward.image,
    code: code
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(history));

  // Animation mở rương (Flashbang)
  setTimeout(() => {
    document.getElementById('flash-overlay').classList.add('flash-active');
    
    setTimeout(() => {
      document.getElementById('phase-1-box').style.display = 'none';
      
      // Hiển thị kết quả cố định
      document.getElementById('reward-img').src = reward.image || chest.src;
      document.getElementById('reward-name').innerText = reward.name;
      document.getElementById('reward-code').innerText = code;
      
      document.getElementById('phase-2-result').style.display = 'flex';
    }, 100);
  }, 2500);
}

// Hàm Random cố định theo Seed
function getSeededWeightedRandom(items, seed) {
  let total = items.reduce((s, i) => s + (i.chance||0), 0);
  // Dùng hàm seededRandom thay vì Math.random()
  let r = seededRandom(seed) * total;
  
  for(let i=0; i<items.length; i++) {
    r -= (items[i].chance||0);
    if(r <= 0) return items[i];
  }
  return items[0];
}

// Hàm tạo Code cố định theo Seed
function generateSeededCode(seed) {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let c = '';
  // Tạo chuỗi ngẫu nhiên nhưng cố định theo seed
  for(let i=0; i<12; i++) { 
    if(i>0 && i%4===0) c+='-';
    // Biến tấu seed để mỗi ký tự khác nhau
    let charIndex = Math.floor(seededRandom(seed + i) * chars.length);
    c += chars.charAt(charIndex); 
  }
  return c;
}

// Hàm hiển thị lại kết quả cũ (Nếu F5)
function showUsedState(savedData) {
  // Ẩn box 1
  document.getElementById('phase-1-box').style.display = 'none';
  
  // Setup và hiện box 2 luôn (không animation)
  document.getElementById('reward-img').src = savedData.image || "https://cdn-icons-png.flaticon.com/512/4230/4230569.png";
  document.getElementById('reward-name').innerText = savedData.name;
  document.getElementById('reward-code').innerText = savedData.code;
  
  // Đổi text tiêu đề một chút để biết là đã mở rồi
  document.querySelector('.rarity-label').innerText = "ĐÃ MỞ KHÓA (ALREADY OPENED)";
  document.querySelector('.rarity-label').style.color = "#aaa";
  
  document.getElementById('phase-2-result').style.display = 'flex';
}
</script>