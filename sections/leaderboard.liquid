{% comment %} 
  V6 GOD MODE: S·ª≠ d·ª•ng k·ªπ thu·∫≠t 100vw + Transform ƒë·ªÉ √©p Full m√†n h√¨nh
  k·∫øt h·ª£p Script ch·∫∑n thanh cu·ªôn ngang.
{% endcomment %}

<!-- Container ch√≠nh -->
<div class="leaderboard-god-mode-wrapper">
  <div class="leaderboard-inner-content">
    
    <div class="header-wrapper">
      <h2 class="leaderboard-title">üèÜ TOP LOYAL CUSTOMERS üèÜ</h2>
      <p class="leaderboard-subtitle">Weekly Leaderboard</p>
    </div>
    
    <table id="leaderboard-table">
      <thead>
        <tr>
          <th style="width: 15%;">RANK</th>
          <th style="width: 55%;">NAME</th>
          <th style="width: 30%;">POINTS</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="3" class="loading-text">Loading Data...</td></tr>
      </tbody>
    </table>

  </div>
</div>

<style>
  /* 1. K·ª∏ THU·∫¨T PH√Å V·ª† GI·ªöI H·∫†N (BREAKOUT) */
  .leaderboard-god-mode-wrapper {
    /* √âp chi·ªÅu r·ªông b·∫±ng ƒë√∫ng chi·ªÅu r·ªông m√†n h√¨nh thi·∫øt b·ªã */
    width: 100vw !important; 
    
    /* CƒÉn gi·ªØa tuy·ªát ƒë·ªëi d·ª±a tr√™n m√†n h√¨nh, kh√¥ng d·ª±a tr√™n theme */
    position: relative !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    
    background-color: #000000;
    color: #ffffff;
    padding: 60px 0;
  }

  /* 2. N·ªòI DUNG B√äN TRONG */
  .leaderboard-inner-content {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 20px;
    text-align: center;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  /* 3. STYLE GIAO DI·ªÜN (GI·ªÆ NGUY√äN) */
  .leaderboard-title {
    color: #FFD700; 
    font-size: 2.2rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin: 0;
    line-height: 1.3;
  }
  .leaderboard-subtitle { color: #888; text-transform: uppercase; margin-top: 10px; letter-spacing: 1px; }

  table { 
    width: 100%; 
    border-collapse: separate; 
    border-spacing: 0;
    background-color: #111; 
    border-radius: 12px;
    border: 1px solid #333;
    overflow: hidden;
    margin-top: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  th { background-color: #222; color: #fff; padding: 18px; border-bottom: 2px solid #444; text-align: center; }
  td { padding: 15px; border-bottom: 1px solid #333; color: #ddd; text-align: center; }
  tr:last-child td { border-bottom: none; }

  /* M√ÄU TOP 3 */
  tr.rank-1 td { color: #FFD700; font-weight: bold; background: rgba(255, 215, 0, 0.15); }
  tr.rank-2 td { color: #E0E0E0; font-weight: bold; background: rgba(255, 255, 255, 0.1); }
  tr.rank-3 td { color: #CD7F32; font-weight: bold; background: rgba(205, 127, 50, 0.15); }

  .loading-text { font-style: italic; color: #666; padding: 40px; }
  .error-text { color: #ff4d4d; padding: 20px; font-weight: bold; }
</style>

<script>
  // --- JS FIX THANH CU·ªòN NGANG (SCROLLBAR FIX) ---
  // Khi d√πng 100vw, Windows s·∫Ω hi·ªán thanh cu·ªôn ngang. Script n√†y s·∫Ω ch·∫∑n n√≥.
  function preventHorizontalScroll() {
    // √âp body v√† html kh√¥ng ƒë∆∞·ª£c cu·ªôn ngang
    document.documentElement.style.overflowX = 'hidden';
    document.body.style.overflowX = 'hidden';
    
    // T√¨m section cha c·ªßa Shopify v√† reset padding/margin n·∫øu c√≥
    const wrapper = document.querySelector('.leaderboard-god-mode-wrapper');
    if(wrapper) {
      let parent = wrapper.parentElement;
      // Leo l√™n 3 c·∫•p ƒë·ªÉ ƒë·∫£m b·∫£o x√≥a h·∫øt padding c·ªßa theme
      for(let i=0; i<3; i++) {
        if(parent) {
          parent.style.padding = '0';
          parent.style.margin = '0';
          parent.style.maxWidth = 'none';
          parent.style.width = '100%';
          parent = parent.parentElement;
        }
      }
    }
  }

  window.addEventListener('load', preventHorizontalScroll);
  window.addEventListener('resize', preventHorizontalScroll);
  setTimeout(preventHorizontalScroll, 100);
</script>

<script type="module">
  // --- FIREBASE LOGIC ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getDatabase, ref, query, orderByChild, limitToLast, get } 
    from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBOg7VD7SdFREtVqqBtRcKiGYe-aMUY4mc",
    authDomain: "shopify-e88b6.firebaseapp.com",
    projectId: "shopify-e88b6",
    storageBucket: "shopify-e88b6.firebasestorage.app",
    messagingSenderId: "866420293794",
    appId: "1:866420293794:web:79805088b41cee137697fb",
    measurementId: "G-S8VH3MGBRQ",
    databaseURL: "https://shopify-e88b6-default-rtdb.asia-southeast1.firebasedatabase.app/" 
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  async function loadLeaderboard() {
    // Ch·∫°y l·∫°i fix layout tr∆∞·ªõc khi t·∫£i
    if(window.preventHorizontalScroll) window.preventHorizontalScroll();

    const usersRef = query(ref(db, 'users'), orderByChild('points'), limitToLast(10));
    try {
      const snapshot = await get(usersRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        let leaderboard = Object.values(data).sort((a, b) => b.points - a.points);
        renderTable(leaderboard);
      } else {
        document.querySelector('#leaderboard-table tbody').innerHTML = "<tr><td colspan='3' class='loading-text'>No data found.</td></tr>";
      }
    } catch (error) {
      console.error(error);
      let msg = "Connection Error.";
      if(error.message && error.message.includes("Index not defined")) msg = "‚ö†Ô∏è ERROR: Index not defined (Check Firebase Rules)";
      else if(error.code === "permission_denied") msg = "‚ö†Ô∏è ACCESS DENIED (Check Firebase Rules)";
      document.querySelector('#leaderboard-table tbody').innerHTML = `<tr><td colspan='3' class='error-text'>${msg}</td></tr>`;
    }
  }

  function renderTable(users) {
    let html = '';
    users.forEach((user, index) => {
      let rank = index + 1;
      let name = user.name || "Anonymous";
      
      let rankIcon = rank;
      if (rank === 1) rankIcon = 'ü•á 1st';
      else if (rank === 2) rankIcon = 'ü•à 2nd';
      else if (rank === 3) rankIcon = 'ü•â 3rd';
      
      html += `
        <tr class="rank-${rank}">
          <td>${rankIcon}</td>
          <td>${name}</td>
          <td>${user.points ? user.points.toLocaleString() : 0}</td>
        </tr>
      `;
    });
    document.querySelector('#leaderboard-table tbody').innerHTML = html;
  }
  
  loadLeaderboard();
</script>

{% schema %}
{
  "name": "Leaderboard God Mode",
  "tag": "section",
  "class": "section",
  "settings": [],
  "presets": [
    {
      "name": "Leaderboard God Mode"
    }
  ]
}
{% endschema %}