<!-- LOOTBOX GACHA SECTION - RANDOM AFTER CHECKOUT -->
<!-- HIDDEN LOOT TABLE DATA (parse after checkout) -->
<div id="loot-table-json" style="display:none;">
[{% if product.metafields.custom.lootbox.value %}{% for item in product.metafields.custom.lootbox.value %}{"name":"{{ item.name | escape }}","image":"{{ item.image | image_url: width: 600 }}","chance":{{ item.chance | default: 0 }}}{% unless forloop.last %},{% endunless %}{% endfor %}{% endif %}]
</div>

<!-- 1. DATA CONFIGURATION -->
<script>
  var currentVariantId = {{ product.selected_or_first_available_variant.id }};
  var currentProductHandle = "{{ product.handle }}";
  var currentProductImage = "{{ product.featured_image | image_url: width: 500 }}";
  var currentProductTitle = "{{ product.title | escape }}";
</script>

<!-- 2. TRIGGER BUTTON -->
<div class="lootbox-trigger-wrapper">
  <button id="btn-start-gacha" onclick="startLootboxPurchase()">
    <div class="btn-content">
      <span class="icon">üé∞</span>
      <span class="text">BUY & OPEN BOX</span>
    </div>
    <span class="sub-text">{{ product.price | money }} / Per open</span>
  </button>
  <p class="note">‚ö†Ô∏è Result will be randomly drawn AFTER successful payment!</p>
</div>

<!-- 3. LOOT TABLE PREVIEW -->
<div class="loot-table-preview">
  <h4>üì¶ Possible rewards:</h4>
  <div class="loot-items">
    {% if product.metafields.custom.lootbox.value %}
      {% for item in product.metafields.custom.lootbox.value %}
        <div class="loot-item">
          <img src="{{ item.image | image_url: width: 100 }}" alt="{{ item.name }}">
          <span class="loot-name">{{ item.name }}</span>
          <span class="loot-chance">{{ item.chance }}%</span>
        </div>
      {% endfor %}
    {% endif %}
  </div>
</div>

<!-- 4. CONFIRMATION MODAL -->
<div id="lootbox-confirm-modal" class="lb-modal-overlay" style="display:none;">
  <div class="lb-modal-box">
    <img src="{{ product.featured_image | image_url: width: 300 }}" alt="{{ product.title }}" class="lb-product-img">
    <h2>üéÅ {{ product.title }}</h2>
    <p style="color:#ff9800; margin: 15px 0;">‚ö†Ô∏è You will randomly receive 1 item AFTER successful checkout.</p>
    <p style="color:#aaa; font-size:14px;">The result is completely random and cannot be predicted!</p>
    <div class="lb-modal-buttons">
      <button class="lb-btn-cancel" onclick="closeLootboxConfirm()">‚ùå CANCEL</button>
      <button class="lb-btn-confirm" onclick="proceedToCheckout()">üí≥ CHECKOUT NOW</button>
    </div>
  </div>
</div>

<!-- 5. RESULT MODAL (Show after checkout) -->
<div id="lootbox-result-modal" class="lb-modal-overlay" style="display:none;">
  <div class="lb-result-container">
    <!-- Phase 1: Opening Animation -->
    <div id="lb-opening-phase">
      <img src="{{ product.featured_image | image_url: width: 300 }}" class="lb-box-shaking" alt="Opening...">
      <h2 class="lb-opening-text">OPENING BOX...</h2>
    </div>
    
    <!-- Phase 2: Result -->
    <div id="lb-result-phase" style="display:none;">
      <div class="lb-halo"></div>
      <img id="lb-result-img" src="" alt="Prize" class="lb-prize-img">
      <div class="lb-result-info">
        <div class="lb-label">YOU RECEIVED</div>
        <h2 id="lb-result-name">ITEM</h2>
        <div class="lb-badge" id="lb-result-chance">Drop Rate: ?%</div>
      </div>
      <button class="lb-btn-close" onclick="closeResultModal()">üéâ AWESOME!</button>
    </div>
  </div>
</div>

<!-- 6. CSS -->
<style>
  .lootbox-trigger-wrapper { margin: 20px 0; text-align: center; }
  #btn-start-gacha {
    width: 100%; background: linear-gradient(135deg, #ff0055 0%, #ff4400 100%);
    border: none; padding: 15px; border-radius: 10px; color: white; cursor: pointer;
    box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4); transition: transform 0.2s;
  }
  #btn-start-gacha:hover { transform: scale(1.02); }
  .btn-content { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 20px; font-weight: 800; }
  .sub-text { font-size: 13px; opacity: 0.9; margin-top: 4px; display: block; }
  .note { font-size: 12px; color: #ff9800; margin-top: 10px; font-weight: bold; }

  /* Loot Table Preview */
  .loot-table-preview { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; }
  .loot-table-preview h4 { margin: 0 0 15px; color: #ffd700; }
  .loot-items { display: flex; flex-wrap: wrap; gap: 10px; }
  .loot-item { 
    display: flex; flex-direction: column; align-items: center; 
    padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; min-width: 80px;
  }
  .loot-item img { width: 60px; height: 60px; object-fit: contain; border-radius: 5px; }
  .loot-name { font-size: 11px; margin-top: 5px; text-align: center; color: #fff; }
  .loot-chance { font-size: 10px; color: #4cd137; font-weight: bold; }

  /* Modal Overlay */
  .lb-modal-overlay {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.95); z-index: 999999;
    display: flex; align-items: center; justify-content: center;
  }
  .lb-modal-box {
    background: #1a1a2e; padding: 30px; border-radius: 15px; text-align: center;
    max-width: 400px; width: 90%; border: 2px solid #ffd700;
  }
  .lb-product-img { width: 150px; height: 150px; object-fit: contain; margin-bottom: 15px; }
  .lb-modal-buttons { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
  .lb-btn-cancel { 
    padding: 12px 25px; background: #333; border: 1px solid #666; color: #fff; 
    border-radius: 8px; cursor: pointer; font-weight: bold;
  }
  .lb-btn-confirm {
    padding: 12px 25px; background: linear-gradient(135deg, #4cd137, #2ecc71); 
    border: none; color: #fff; border-radius: 8px; cursor: pointer; font-weight: bold;
  }

  /* Result Modal */
  .lb-result-container { text-align: center; padding: 30px; }
  .lb-box-shaking { 
    width: 200px; height: 200px; object-fit: contain;
    animation: lbShake 0.3s infinite;
  }
  @keyframes lbShake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(5deg); }
    75% { transform: rotate(-5deg); }
  }
  .lb-opening-text { color: #fff; margin-top: 20px; font-size: 24px; }
  
  .lb-halo {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, transparent 70%);
    z-index: -1; animation: lbBreathe 2s infinite alternate;
  }
  @keyframes lbBreathe { from { opacity: 0.5; } to { opacity: 1; } }
  
  .lb-prize-img {
    width: 250px; height: 250px; object-fit: contain;
    filter: drop-shadow(0 0 20px gold);
    animation: lbZoomIn 0.5s ease-out;
  }
  @keyframes lbZoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  
  .lb-result-info { margin-top: 20px; }
  .lb-label { color: #aaa; font-size: 14px; letter-spacing: 2px; }
  #lb-result-name { color: #ffd700; font-size: 28px; margin: 10px 0; }
  .lb-badge { background: #222; border: 1px solid #444; padding: 5px 15px; border-radius: 20px; display: inline-block; }
  .lb-btn-close {
    margin-top: 25px; padding: 15px 40px; background: linear-gradient(135deg, #ffd700, #ff8c00);
    border: none; color: #000; font-weight: bold; font-size: 16px; border-radius: 10px; cursor: pointer;
  }
</style>

<!-- 7. JAVASCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Check URL param to know just finished checkout
  const urlParams = new URLSearchParams(window.location.search);
  const openResult = urlParams.get('open_result');
  
  if (openResult === 'true') {
    // Remove param from URL (so refresh won't reopen)
    window.history.replaceState({}, '', window.location.pathname);
    // Random and show result
    showLootboxResult();
  }
});

function startLootboxPurchase() {
  document.getElementById('lootbox-confirm-modal').style.display = 'flex';
}

function closeLootboxConfirm() {
  document.getElementById('lootbox-confirm-modal').style.display = 'none';
}

function proceedToCheckout() {
  // Save product handle to localStorage for Custom Pixel redirect
  localStorage.setItem('pending_lootbox', JSON.stringify({
    handle: currentProductHandle,
    timestamp: Date.now()
  }));
  
  // Add to cart and redirect to checkout
  fetch(window.Shopify.routes.root + 'cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      items: [{
        id: currentVariantId,
        quantity: 1,
        properties: {
          '_lootbox': 'true'
        }
      }]
    })
  })
  .then(res => {
    if (res.ok) {
      window.location.href = '/checkout';
    } else {
      alert('Error! Please try again.');
      localStorage.removeItem('pending_lootbox');
    }
  })
  .catch(e => {
    console.error(e);
    alert('Connection error!');
    localStorage.removeItem('pending_lootbox');
  });
}

function showLootboxResult() {
  // Get loot table from hidden div
  const lootTableEl = document.getElementById('loot-table-json');
  if (!lootTableEl) {
    console.error('Loot table not found!');
    return;
  }
  
  let lootTable;
  try {
    lootTable = JSON.parse(lootTableEl.textContent);
  } catch(e) {
    console.error('Invalid loot table:', e);
    return;
  }
  
  if (!lootTable || lootTable.length === 0) {
    alert('No loot table data!');
    return;
  }
  
  // Show modal with animation
  const modal = document.getElementById('lootbox-result-modal');
  const openingPhase = document.getElementById('lb-opening-phase');
  const resultPhase = document.getElementById('lb-result-phase');
  
  modal.style.display = 'flex';
  openingPhase.style.display = 'block';
  resultPhase.style.display = 'none';
  
  // Random after 2.5s
  setTimeout(() => {
    const reward = getWeightedRandom(lootTable);
    
    openingPhase.style.display = 'none';
    resultPhase.style.display = 'block';
    
    document.getElementById('lb-result-img').src = reward.image;
    document.getElementById('lb-result-name').textContent = reward.name;
    document.getElementById('lb-result-chance').textContent = 'Drop Rate: ' + reward.chance + '%';
    
    // Clear pending
    localStorage.removeItem('pending_lootbox');
  }, 2500);
}

function getWeightedRandom(items) {
  let total = items.reduce((sum, item) => sum + (item.chance || 0), 0);
  let random = Math.random() * total;
  let sum = 0;
  for (let i = 0; i < items.length; i++) {
    sum += items[i].chance || 0;
    if (random <= sum) return items[i];
  }
  return items[0];
}

function closeResultModal() {
  document.getElementById('lootbox-result-modal').style.display = 'none';
}
</script>

{% schema %}
{
  "name": "Lootbox Gacha",
  "settings": [],
  "presets": [
    {
      "name": "Lootbox Gacha"
    }
  ]
}
{% endschema %}
