<!doctype html>
{% comment %} --- LOGIC T√çNH RANK & M√ÄU S·∫ÆC --- {% endcomment %}
{% assign current_spent = customer.total_spent | default: 0 %}
{% assign rpg_rank_title = "Tan Thu" %}
{% assign rpg_rank_color = "#999" %} 

{% if current_spent >= 30000000 %}
  {% assign rpg_rank_title = "GODSLAYER" %}
  {% assign rpg_rank_color = "#ffd700" %} <!-- V√†ng kim -->
{% elsif current_spent >= 18000000 %}
  {% assign rpg_rank_title = "MYTHIC" %}
  {% assign rpg_rank_color = "#00e5ff" %} <!-- Xanh Cyan -->
{% elsif current_spent >= 12000000 %}
  {% assign rpg_rank_title = "DRAGONBANE" %}
  {% assign rpg_rank_color = "#ff3d00" %} <!-- ƒê·ªè cam -->
{% elsif current_spent >= 8000000 %}
  {% assign rpg_rank_title = "VANGUARD" %}
  {% assign rpg_rank_color = "#d500f9" %} <!-- T√≠m -->
{% elsif current_spent >= 5000000 %}
  {% assign rpg_rank_title = "SHADOW" %}
  {% assign rpg_rank_color = "#aa00ff" %} <!-- T√≠m ƒë·∫≠m -->
{% elsif current_spent >= 2000000 %}
  {% assign rpg_rank_title = "HUNTER" %}
  {% assign rpg_rank_color = "#2979ff" %} <!-- Xanh d∆∞∆°ng -->
{% elsif current_spent >= 500000 %}
  {% assign rpg_rank_title = "WANDERER" %}
  {% assign rpg_rank_color = "#00e676" %} <!-- Xanh l√° -->
{% endif %}
<html class="no-js" lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">

    <!-- 1. FONT CH·ªÆ GAME RPG -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    <title>{{ page_title }}</title>

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {{ content_for_header }}

    <!-- 2. CSS RPG - FULL WIDTH & NEW MODALS -->
    <style>
      /* CSS CHO TAG RANK */
.rpg-rank-badge {
  font-size: 9px;            /* Ch·ªØ nh·ªè h∆°n t√™n Class */
  font-weight: 700;
  text-transform: uppercase;
  padding: 1px 5px;          /* Kho·∫£ng c√°ch trong vi·ªÅn */
  border: 1px solid;         /* Vi·ªÅn m·ªèng */
  border-radius: 2px;        /* Bo g√≥c nh·∫π */
  background: rgba(0, 0, 0, 0.4); /* N·ªÅn ƒëen m·ªù ƒë·ªÉ n·ªïi b·∫≠t ch·ªØ */
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
  animation: glowPulse 3s infinite alternate; /* Hi·ªáu ·ª©ng nh·∫•p nh√°y nh·∫π */
}
/* Hi·ªáu ·ª©ng s√°ng nh·∫π */
@keyframes glowPulse {
  0% { opacity: 0.8; }
  100% { opacity: 1; text-shadow: 0 0 5px currentColor; }
}
      :root {
        --rpg-gold: #ffd700;
        --rpg-dark: #0a0a0c;
        --class-color: #ffd700; /* M·∫∑c ƒë·ªãnh */
      }

      /* FIX FULL WIDTH & BACKGROUND */
      body {
        background-color: var(--rpg-dark) !important;
        color: #e0e0e0 !important;
        font-family: 'Roboto', sans-serif;
        padding-top: 60px !important;
        overflow-x: hidden;
      }

      .page-width, .page-width-desktop {
        max-width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
        margin: 0 !important;
      }

      .gradient { background: transparent !important; }

      /* === CLASS COLOR BORDERS FOR UI ELEMENTS === */
      /* Product Cards */
      .card, .card-wrapper, .product-card, .product-card-wrapper,
      .card--standard, .card--card, .card--media {
        border: 1px solid var(--class-color) !important;
        box-shadow: 0 0 10px rgba(var(--class-color-rgb, 255,215,0), 0.2);
        transition: all 0.3s ease;
      }
      .card:hover, .card-wrapper:hover, .product-card:hover {
        border-color: var(--class-color) !important;
        box-shadow: 0 0 20px rgba(var(--class-color-rgb, 255,215,0), 0.4);
        transform: translateY(-3px);
      }

      /* Buttons */
      .button, .btn, button:not(.plain),
      .shopify-payment-button__button,
      .product-form__submit,
      input[type="submit"],
      .cart__checkout-button {
        border: 2px solid var(--class-color) !important;
        box-shadow: 0 0 8px rgba(var(--class-color-rgb, 255,215,0), 0.3);
        transition: all 0.3s ease;
      }
      .button:hover, .btn:hover, button:not(.plain):hover,
      .shopify-payment-button__button:hover,
      .product-form__submit:hover {
        box-shadow: 0 0 15px var(--class-color);
        transform: scale(1.02);
      }

      /* Input Fields */
      input[type="text"]:not(.search__input), 
input[type="email"], 
input[type="password"],
      input[type="number"], input[type="tel"],
      textarea, select {
        border: 1px solid var(--class-color) !important;
        background: rgba(0,0,0,0.5) !important;
        color: #fff !important;
        transition: all 0.3s ease;
      }
      input:focus, textarea:focus, select:focus {
        border-color: var(--class-color) !important;
        box-shadow: 0 0 10px var(--class-color);
        outline: none;
      }

      /* Collection Cards */
      .collection-card, .collection-list__item {
        border: 1px solid var(--class-color) !important;
      }

      /* Cart Items */
      .cart-item, .cart-item__details {
        border-bottom: 1px solid var(--class-color) !important;
      }

      /* Nav Links in HUD - use class color */
      .hud-nav-link {
        border-color: var(--class-color) !important;
        color: var(--class-color) !important;
      }
      .hud-nav-link:hover {
        background: var(--class-color) !important;
        color: #000 !important;
      }

      /* Quantity Selector */
      .quantity, .quantity-selector, quantity-input {
        border: 1px solid var(--class-color) !important;
      }

      /* Accordion / Disclosure */
details:not(.header__search), 
.accordion, 
summary:not(.header__icon) {
  border-color: var(--class-color) !important;
}

      /* Modal / Popup borders */
      .modal__content, .drawer__content, .popup-content {
        border: 2px solid var(--class-color) !important;
      }

      h1, h2, h3, h4, h5, h6, .h1, .h2 {
        font-family: 'Cinzel', serif !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #fff !important;
      }

      /* --- RPG HUD --- */
      #rpg-hud {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        background: rgba(10, 10, 12, 0.95);
        border-bottom: 2px solid var(--class-color);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 30px; z-index: 100;
        box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        backdrop-filter: blur(5px); font-family: 'Cinzel', serif;
      }
      
      /* Ensure Shopify header and search are above HUD */
      .shopify-section-header,
      .header,
      .header__search,
      .search-modal,
      .predictive-search {
        z-index: 10001 !important;
      }
      .hud-left { display: flex; align-items: center; gap: 15px; }
      .hud-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--class-color); object-fit: cover; }
      
      .hud-right { 
  display: flex; 
  align-items: center; 
  gap: 20px; 
  padding-right: 50px; /* <--- TH√äM D√íNG N√ÄY (TƒÉng s·ªë n√†y l√™n n·∫øu mu·ªën d·ªùi v√†o s√¢u h∆°n) */
}
      
      /* Thanh Ti·∫øn ƒê·ªô VIP */
      .vip-wrapper { text-align: right; }
      .vip-label { font-size: 14px; font-weight: bold; color: var(--class-color); }
      .xp-container { width: 150px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 2px; }
      .xp-fill { height: 100%; background: linear-gradient(90deg, var(--class-color), #fff); width: 0%; transition: width 1s ease-out; }
      
      /* Daily Activity Points */
      .hud-ap { font-size: 12px; color: #a335ee; font-weight: bold; border: 1px solid #a335ee; padding: 2px 6px; border-radius: 4px; }
      .hud-ap:hover {
  background-color: #a335ee;
  color: #fff !important;
  box-shadow: 0 0 10px #a335ee;
  transition: 0.3s;
}
      /* --- HUD NAV LINKS --- */
      .hud-nav-link {
        display: flex; align-items: center; gap: 5px;
        color: #ffd700; font-size: 12px; font-weight: bold;
        text-decoration: none; padding: 5px 10px;
        border: 1px solid #ffd700; border-radius: 4px;
        transition: all 0.3s;
      }
      .hud-nav-link:hover {
        background: #ffd700; color: #000 !important;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      }
      /* --- INVENTORY ICON --- */
      .hud-inventory-btn {
        font-size: 22px; cursor: pointer; position: relative;
        transition: transform 0.2s; padding: 5px;
      }
      .hud-inventory-btn:hover { transform: scale(1.15); }
      .inventory-count {
        position: absolute; top: -5px; right: -8px;
        background: #ff4d4d; color: #fff; font-size: 10px; font-weight: bold;
        min-width: 18px; height: 18px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid #0a0a0c;
      }
      .inventory-count:empty, .inventory-count[data-count="0"] { display: none; }
      
      /* --- INVENTORY ITEMS --- */
      .inv-item {
        display: flex; align-items: center; gap: 15px;
        background: rgba(255,255,255,0.05); border: 1px solid #333;
        padding: 12px; border-radius: 8px; margin-bottom: 10px;
        transition: all 0.3s;
      }
      .inv-item:hover { border-color: #ffd700; background: rgba(255,215,0,0.1); }
      .inv-item-img { width: 50px; height: 50px; object-fit: contain; border-radius: 5px; }
      .inv-item-info { flex: 1; text-align: left; }
      .inv-item-name { font-weight: bold; color: #fff; font-size: 14px; }
      .inv-item-date { font-size: 11px; color: #888; }
      .inv-item-btn {
        background: linear-gradient(135deg, #ff0055, #ff4400);
        border: none; color: #fff; padding: 8px 15px; border-radius: 5px;
        cursor: pointer; font-weight: bold; font-size: 12px;
        transition: transform 0.2s;
      }
      .inv-item-btn:hover { transform: scale(1.05); }
      
      /* --- GIFT ICON --- */
      .hud-gift-btn {
        font-size: 24px; cursor: pointer; position: relative;
        transition: transform 0.2s;
      }
      .hud-gift-btn:hover { transform: scale(1.2) rotate(-10deg); }
      .noti-dot {
        position: absolute; top: -2px; right: -2px; width: 10px; height: 10px;
        background: #ff4d4d; border-radius: 50%; border: 1px solid #fff;
        display: none; animation: pulse 1s infinite;
      }
      @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);} 70% {box-shadow: 0 0 0 5px rgba(255, 77, 77, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);} }

      /* --- GENERIC POPUP (THAY TH·∫æ ALERT) --- */
      .rpg-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
      }
      .rpg-modal-box {
        background: #151515; border: 2px solid var(--class-color);
        padding: 30px; width: 350px; text-align: center; border-radius: 12px;
        color: #fff; box-shadow: 0 0 40px rgba(0,0,0,0.5);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes popIn { from {transform: scale(0.5); opacity: 0;} to {transform: scale(1); opacity: 1;} }

      .modal-icon-lg { font-size: 50px; margin-bottom: 15px; display: block; }
      .modal-title { color: var(--class-color); font-size: 20px; margin-bottom: 10px; font-weight: bold; }
      .modal-msg { font-size: 14px; color: #ccc; line-height: 1.5; margin-bottom: 20px; }
      
      .rpg-btn-primary {
        background: var(--class-color); color: #000; border: none;
        padding: 10px 25px; font-weight: bold; font-family: 'Cinzel', serif;
        cursor: pointer; width: 100%; text-transform: uppercase;
      }
      .rpg-btn-primary:hover { filter: brightness(1.2); }

      .code-display {
        background: #222; border: 1px dashed #fff; padding: 10px;
        font-size: 18px; color: #2ecc71; font-weight: bold; letter-spacing: 2px;
        margin-bottom: 15px; cursor: pointer; user-select: all;
      }
      /* --- CLASS SELECTION POPUP --- */
      #class-selection-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 200005; display: none;
        flex-direction: column; justify-content: center; align-items: center;
      }
      .class-grid { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center;}
      .class-card {
        width: 240px; background: #151515; border: 1px solid #444; padding: 20px;
        text-align: center; cursor: pointer; transition: 0.3s; border-radius: 8px;
      }
      .class-card:hover { transform: scale(1.05); border-color: var(--hover-color); box-shadow: 0 0 20px var(--hover-color); }
      .class-img { font-size: 50px; margin-bottom: 15px; display: block; }
      .class-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; color: var(--hover-color); }
      .class-desc { font-size: 12px; color: #aaa; }

      /* Fix n√∫t b·∫•m Shopify */
      .button, .shopify-payment-button__button {
        border-radius: 4px !important; font-family: 'Cinzel', serif !important;
      }

    </style>
  </head>

  <body class="gradient">
    
    <!-- 3. RPG HUD (C·∫¨P NH·∫¨T VIP) -->
    <div id="rpg-hud">
<div class="hud-left">
  <!-- Avatar (Gi·ªØ nguy√™n) -->
  <img id="hud-avatar-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" width="40" height="40" alt="Avatar" class="hud-avatar">
  
  <div style="display: flex; flex-direction: column; justify-content: center; margin-left: 12px;">
    
    <!-- D√íNG 1: T√äN CLASS + TAG RANK -->
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
      <!-- T√™n Class -->
      <div style="font-weight:bold; color:var(--class-color); font-size: 1.2em; line-height: 1;" id="hud-class-name">Welcome</div>
      
      <!-- Tag Rank (M·ªöI) -->
      <div class="rpg-rank-badge" style="
          color: {{ rpg_rank_color }}; 
          border-color: {{ rpg_rank_color }};
          box-shadow: 0 0 4px {{ rpg_rank_color }};
      ">
        {{ rpg_rank_title }}
      </div>
    </div>

    <!-- D√íNG 2: CODE BOX (Gi·ªØ nguy√™n nh∆∞ ·∫£nh c·ªßa b·∫°n) -->
    <div id="hud-class-code" style="
        font-size: 10px; 
        color: #ddd; 
        background: rgba(255,255,255,0.15); 
        padding: 2px 6px; 
        border-radius: 3px; 
        display: none; 
        cursor: pointer;
        width: fit-content;
    " onclick="copyToClipboard(this.innerText)">
      CODE: <span id="class-code-text">NONE</span>
    </div>

  </div>
</div>
      <div class="hud-right">
        <!-- NAV LINKS: LEADERBOARD -->
        <a href="/pages/leaderboard" class="hud-nav-link" title="Leaderboard">
          üèÜ <span class="mobile-hide">Rank</span>
        </a>
        
        <!-- NAV LINKS: QUESTS -->
        <a href="/pages/quest-board" class="hud-nav-link" title="Archivement">
          üìú <span class="mobile-hide">Archivement</span>
        </a>
        
        <!-- NAV LINKS: GOLD & LOOTBOX SHOP -->
        <a href="/pages/gold-shop" class="hud-nav-link" title="HALL OF GLORY" style="color: #ffd700;">
          ü™ô <span class="mobile-hide">HALL OF GLORY</span>
        </a>
        
        <!-- NAV LINKS: AP SHOP -->
        <a href="/pages/ap-shop" class="hud-nav-link" title="AP Shop">
          üõçÔ∏è <span class="mobile-hide">AP Shop</span>
        </a>
        
        <!-- ICON DISCOUNT CODES -->
        <div class="hud-inventory-btn" onclick="openInventory()" title="My Discount Codes">
          üéüÔ∏è
          <span class="inventory-count" id="inventory-count">0</span>
        </div>
        
        <!-- ICON DAILY REWARD -->
        <div class="hud-gift-btn" onclick="openDailyPopup()" title="Daily Reward">
          üéÅ
          <div id="gift-noti" class="noti-dot"></div>
        </div>

        <div class="vip-wrapper">
          <div class="vip-label"><span id="hud-vip-rank">VIP 0</span></div>
          <div class="xp-container"><div class="xp-fill" id="hud-vip-bar"></div></div>
        </div>

        <div style="text-align: right;">
          <!-- GOLD DISPLAY -->
          <a href="/pages/gold-shop" style="color:#ffd700; font-weight: bold; text-decoration:none; display:block; margin-bottom:3px;" title="Click to buy more Gold">
            ü™ô <span id="hud-gold-display">0</span> Gold
          </a>
          <!-- AP POINTS -->
          <a href="/pages/ap-shop" id="hud-ap-display" class="hud-ap" style="display:none; text-decoration:none; cursor:pointer; font-size:12px;" title="Click to visit AP Shop">
            ‚ö° 0 AP
          </a>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT SHOPIFY -->
    {% sections 'header-group' %}
    <main id="MainContent" class="content-for-layout" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>
    {% sections 'footer-group' %}

    <!-- 4. CLASS SELECTION MODAL -->
    <div id="class-selection-modal">
      <h1 style="color: #fff; font-size: 2.5rem; letter-spacing: 3px;">CHOOSE YOUR CLASS</h1>
      <p style="color: #888;">Your journey begins here{% if customer %}, <span style="color: var(--rpg-gold);">{{ customer.first_name | default: 'Adventurer' }}</span>{% endif %}</p>
      <div class="class-grid">
        <div class="class-card" style="--hover-color: #ff4d4d;" onclick="selectRPGClass('Warrior', '#ff4d4d')">
          <span class="class-img">‚öîÔ∏è</span><div class="class-title">WARRIOR</div><p class="class-desc">Strength & Melee</p>
        </div>
        <div class="class-card" style="--hover-color: #a335ee;" onclick="selectRPGClass('Mage', '#a335ee')">
          <span class="class-img">üîÆ</span><div class="class-title">MAGE</div><p class="class-desc">Magic & Intelligence</p>
        </div>
        <div class="class-card" style="--hover-color: #2ecc71;" onclick="selectRPGClass('Archer', '#2ecc71')">
          <span class="class-img">üèπ</span><div class="class-title">ARCHER</div><p class="class-desc">Speed & Precision</p>
        </div>
      </div>
    </div>

    <!-- 5. DAILY REWARD MODAL -->
    <div id="daily-reward-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span onclick="closeModal('daily-reward-modal')" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; color:#888;">‚úï</span>
        <h3 style="color:#ffd700; margin-top:0;">DAILY CHECK-IN</h3>
        <p style="font-size:12px; color:#aaa;">Streak: <span id="streak-day" style="color:#fff; font-weight:bold;">1</span></p>
        
        <div style="margin: 20px 0; font-size: 60px;">üéÅ</div>
        <div id="reward-info" style="margin-bottom:20px; font-weight:bold; font-size:1.1em;">
          Reward waiting...
        </div>

        <button id="btn-claim-reward" class="rpg-btn-primary" onclick="claimReward()">CLAIM REWARD</button>
        <p id="reward-timer" style="font-size:10px; color:#666; margin-top:10px;"></p>
      </div>
    </div>

    <!-- 6. INVENTORY MODAL - DISCOUNT CODES -->
    <div id="inventory-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box" style="width: 500px; max-width: 95vw;">
        <span onclick="closeModal('inventory-modal')" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; color:#888;">‚úï</span>
        <h3 style="color:#ffd700; margin-top:0;">üéüÔ∏è MY DISCOUNT CODES</h3>
        <p style="font-size:12px; color:#aaa; margin-bottom:20px;">Your VIP, Class & Earned discount codes</p>
        
        <div id="inventory-items" style="max-height: 350px; overflow-y: auto;">
          <p style="color:#666; font-style:italic;">Inventory empty...</p>
        </div>
      </div>
    </div>

    <!-- 7. CUSTOM ALERT MODAL (REPLACES ALERT) -->
    <div id="custom-alert-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span class="modal-icon-lg" id="alert-icon">üéâ</span>
        <div class="modal-title" id="alert-title">NOTIFICATION</div>
        <div class="modal-msg" id="alert-msg">Message content</div>
        <button class="rpg-btn-primary" onclick="closeModal('custom-alert-modal')">CLOSE</button>
      </div>
    </div>

    <!-- 8. GIFTCODE MODAL (REPLACES PROMPT) -->
    <div id="giftcode-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span class="modal-icon-lg">üëë</span>
        <div class="modal-title" style="color:#2ecc71">JACKPOT!</div>
        <div class="modal-msg">Congratulations! You received a Special Discount Code:</div>
        
        <div class="code-display" id="giftcode-display" onclick="copyToClipboard(this.innerText)">CODE_HERE</div>
        <p style="font-size:10px; color:#888; margin-bottom:15px;">(Click to copy)</p>
        
        <button class="rpg-btn-primary" onclick="closeModal('giftcode-modal')">AWESOME</button>
      </div>
    </div>

    <!-- 9. JS LOGIC -->
    <script>
      // FIX LANGUAGE ERROR
      window.shopUrl = '{{ request.origin }}';
      window.routes = { cart_add_url: '{{ routes.cart_add_url }}', cart_change_url: '{{ routes.cart_change_url }}', cart_update_url: '{{ routes.cart_update_url }}', cart_url: '{{ routes.cart_url }}', predictive_search_url: '{{ routes.predictive_search_url }}' };
      window.cartStrings = { error: `Cart error`, quantityError: `Invalid quantity` };
      window.variantStrings = { addToCart: `Add to cart`, soldOut: `Sold out`, unavailable: `Unavailable` };
      window.accessibilityStrings = { imageAvailable: `Image available`, shareSuccess: `Link copied`, pauseSlideshow: `Pause`, playSlideshow: `Play` };

      // --- RPG SYSTEM CONFIG ---
      const REAL_MONEY = {{ customer.total_spent | default: 0 }} / 100; // Real money spent
      
      // VIP TIERS CONFIG
      const VIP_TIERS = [
        { name: 'VIP 0', min: 0 },
        { name: 'VIP 1', min: 500000 },
        { name: 'VIP 2', min: 5000000 },
        { name: 'VIP 3', min: 12000000 },
        { name: 'VIP 4', min: 20000000 },
        { name: 'VIP 5', min: 30000000 }
      ];

      // Daily Rewards Config (AP points)
      const DAILY_REWARDS = [
        {d:1, val: 50, type:'ap', label:'50 AP'},
        {d:2, val: 100, type:'ap', label:'100 AP'},
        {d:3, val: 150, type:'ap', label:'150 AP'},
        {d:4, val: 200, type:'ap', label:'200 AP'},
        {d:5, val: 300, type:'ap', label:'300 AP'},
        {d:6, val: 500, type:'ap', label:'500 AP'},
        {d:7, val: 'Cheap Product', type:'code', label:'GIFTCODE'}
      ];
      
      // Check if customer is logged in
      {% if customer %}
        const IS_LOGGED_IN = true;
        const CUSTOMER_EMAIL = "{{ customer.email }}";
      {% else %}
        const IS_LOGGED_IN = false;
        const CUSTOMER_EMAIL = null;
      {% endif %}
      
      // Simple storage keys (same for all users on this browser)
      const KEY_DAY = 'rpg_daily_day';
      const KEY_TIME = 'rpg_daily_time';
      const KEY_AP = 'rpg_activity_points';
      const KEY_INVENTORY = 'rpg_discount_codes';
      const KEY_CLASS = 'rpg_class_name';
      const KEY_COLOR = 'rpg_class_color';
      const KEY_GOLD = 'rpg_gold';

      document.addEventListener("DOMContentLoaded", function() {
        console.log('[RPG Debug] DOMContentLoaded fired');
        
        // Update debug panel
        const debugEl = document.getElementById('debug-js');
        if (debugEl) {
          debugEl.innerHTML = `JS OK! | Logged: ${IS_LOGGED_IN} | Class: ${localStorage.getItem(KEY_CLASS) || 'none'}`;
        }
        
        try {
          initRPGSystem();
          checkRewardStatus();
          setInterval(checkRewardStatus, 1000);
          updateInventoryCount(); // Update inventory count
        } catch(e) {
          console.error('[RPG Debug] Error in init:', e);
          const debugEl = document.getElementById('debug-js');
          if (debugEl) debugEl.innerHTML = `ERROR: ${e.message}`;
        }
      });

      function initRPGSystem() {
        console.log('[RPG Debug] Logged in:', IS_LOGGED_IN);
        
        // Read class from storage
        const savedClass = localStorage.getItem(KEY_CLASS);
        const savedColor = localStorage.getItem(KEY_COLOR);
        
        console.log('[RPG Debug] Saved class:', savedClass, 'Color:', savedColor);

        if (!savedClass) {
          console.log('[RPG Debug] No class found, showing selection modal');
          document.getElementById('class-selection-modal').style.display = 'flex';
          document.body.style.overflow = 'hidden'; 
        } else {
          console.log('[RPG Debug] Applying theme for:', savedClass);
          applyTheme(savedClass, savedColor);
        }
        
        // Calculate VIP rank and display AP + Gold
        calculateVipRank();
        updateAPDisplay();
        updateGoldDisplay(); // Update Gold in HUD
        initializeDefaultDiscounts(); // Initialize discount codes
      }

      function selectRPGClass(className, colorHex) {
        // Save class to localStorage
        localStorage.setItem(KEY_CLASS, className);
        localStorage.setItem(KEY_COLOR, colorHex);
        document.getElementById('class-selection-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
        
        // SHOW WELCOME MODAL
        showCustomAlert('üëã', 'WELCOME!', `You have joined the ${className} class!`);
        
        setTimeout(() => location.reload(), 2000); // Reload after 2s
      }

      function applyTheme(className, color) {
        document.documentElement.style.setProperty('--class-color', color);
        document.getElementById('hud-class-name').innerText = className.toUpperCase();
        
        const avatarMap = { 
          'Warrior': 'https://cdn-icons-png.flaticon.com/512/3408/3408593.png', 
          'Mage': 'https://cdn-icons-png.flaticon.com/512/3408/3408545.png', 
          'Archer': 'https://cdn-icons-png.flaticon.com/512/3408/3408605.png' 
        };
        if(avatarMap[className]) document.getElementById('hud-avatar-img').src = avatarMap[className];

        const codeBox = document.getElementById('hud-class-code');
        const codeText = document.getElementById('class-code-text');
        if (className === 'Warrior') codeText.innerText = 'WARRIOR_VIP';
        else if (className === 'Mage') codeText.innerText = 'MAGE_VIP';
        else if (className === 'Archer') codeText.innerText = 'ARCHER_VIP';
        codeBox.style.display = 'inline-block';
      }

      // --- VIP RANK CALCULATION LOGIC (VIP 1 - 5) ---
      function calculateVipRank() {
        let currentRank = 0;
        let nextRankMin = 500000;
        let rankName = 'NOVICE';

        // Determine Rank
        for(let i = 0; i < VIP_TIERS.length; i++) {
          if(REAL_MONEY >= VIP_TIERS[i].min) {
            currentRank = i;
            rankName = VIP_TIERS[i].name;
            if (i < VIP_TIERS.length - 1) {
              nextRankMin = VIP_TIERS[i+1].min;
            } else {
              nextRankMin = REAL_MONEY; // Max level
            }
          }
        }

        // Calculate progress bar %
        // Logic: (Current - Current tier) / (Next tier - Current tier)
        let currentTierMin = VIP_TIERS[currentRank].min;
        let percent = 0;
        if (currentRank < 5) {
           percent = ((REAL_MONEY - currentTierMin) / (nextRankMin - currentTierMin)) * 100;
        } else {
           percent = 100; // Max VIP
        }

        document.getElementById('hud-vip-rank').innerText = rankName;
        document.getElementById('hud-vip-bar').style.width = percent + '%';
      }

      function updateAPDisplay() {
        const ap = parseInt(localStorage.getItem(KEY_AP) || 0);
        const apBox = document.getElementById('hud-ap-display');
        apBox.innerText = `‚ö° ${ap} AP`;
        apBox.style.display = 'inline-block';
      }
      
      // Update Gold display in HUD
      function updateGoldDisplay() {
        const gold = parseInt(localStorage.getItem(KEY_GOLD) || 0);
        const goldEl = document.getElementById('hud-gold-display');
        if (goldEl) goldEl.innerText = gold.toLocaleString();
      }

      // --- LOGIC NH·∫¨N QU√Ä ---
      function openDailyPopup() {
        document.getElementById('daily-reward-modal').style.display = 'flex';
        updatePopupUI();
      }

      function closeModal(id) {
        document.getElementById(id).style.display = 'none';
      }

      function showCustomAlert(icon, title, msg) {
        document.getElementById('alert-icon').innerText = icon;
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-msg').innerText = msg;
        document.getElementById('custom-alert-modal').style.display = 'flex';
      }

      function checkRewardStatus() {
        const last = parseInt(localStorage.getItem(KEY_TIME) || 0);
        const now = new Date().getTime();
        const COOLDOWN = 8640000; // 10s Test (S·ª≠a th√†nh 86400000 ch·∫°y th·∫≠t)
        
        const dot = document.getElementById('gift-noti');
        if(now - last > COOLDOWN) dot.style.display = 'block';
        else dot.style.display = 'none';
      }

      function updatePopupUI() {
        const day = parseInt(localStorage.getItem(KEY_DAY) || 1);
        const last = parseInt(localStorage.getItem(KEY_TIME) || 0);
        const now = new Date().getTime();
        const COOLDOWN = 10000;

        const reward = DAILY_REWARDS[day-1];
        document.getElementById('streak-day').innerText = day;
        
        let rewardText = reward.label;
        document.getElementById('reward-info').innerText = `Your reward today: ${rewardText}`;

        const btn = document.getElementById('btn-claim-reward');
        const timer = document.getElementById('reward-timer');

        if(now - last < COOLDOWN) {
          btn.disabled = true;
          btn.innerText = "COME BACK LATER";
          const diff = COOLDOWN - (now - last);
          timer.innerText = `Wait: ${Math.floor(diff/1000)} seconds`;
        } else {
          btn.disabled = false;
          btn.innerText = "CLAIM REWARD";
          timer.innerText = "Ready!";
        }
      }

      function claimReward() {
        let day = parseInt(localStorage.getItem(KEY_DAY) || 1);
        if(day > 7) day = 1;
        
        const reward = DAILY_REWARDS[day-1];
        const now = new Date().getTime();

        closeModal('daily-reward-modal'); // Close daily popup

        if(reward.type === 'ap') {
          // Add AP points
          let currentAP = parseInt(localStorage.getItem(KEY_AP) || 0);
          let newAP = currentAP + reward.val;
          localStorage.setItem(KEY_AP, newAP);
          
          // SHOW CONGRATULATIONS MODAL
          showCustomAlert('‚ö°', 'CLAIM SUCCESSFUL', `You received ${reward.val} Activity Points (AP).`);
          updateAPDisplay();
          
        } else if (reward.type === 'code') {
          // SHOW GIFTCODE MODAL
          document.getElementById('giftcode-display').innerText = reward.val;
          document.getElementById('giftcode-modal').style.display = 'flex';
        }

        // Save
        localStorage.setItem(KEY_TIME, now);
        if(day < 7) localStorage.setItem(KEY_DAY, day + 1);
        else localStorage.setItem(KEY_DAY, 1);
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        showCustomAlert('üìã', 'COPIED', `Code "${text}" has been copied to clipboard.`);
      }

      // ==========================================
      // DISCOUNT CODES INVENTORY SYSTEM
      // Uses KEY_INVENTORY from customer-specific keys
      // ==========================================
      
      function getDiscountInventory() {
        return JSON.parse(localStorage.getItem(KEY_INVENTORY) || '[]');
      }
      
      function saveDiscountInventory(items) {
        localStorage.setItem(KEY_INVENTORY, JSON.stringify(items));
        updateInventoryCount();
      }
      
      function updateInventoryCount() {
        const items = getDiscountInventory();
        const countEl = document.getElementById('inventory-count');
        if (countEl) {
          countEl.innerText = items.length;
          countEl.setAttribute('data-count', items.length);
        }
      }
      
      // Add discount code to inventory
      function addDiscountToInventory(discountData) {
        const items = getDiscountInventory();
        // Check if code already exists
        if (items.some(item => item.code === discountData.code)) {
          console.log('Discount code already in inventory:', discountData.code);
          return false;
        }
        const newItem = {
          id: Date.now(),
          name: discountData.name || 'Discount Code',
          code: discountData.code,
          type: discountData.type || 'general', // vip, class, quest, shop, daily
          discount: discountData.discount || '???',
          icon: discountData.icon || 'üéüÔ∏è',
          addedAt: new Date().toISOString(),
          expiresAt: discountData.expiresAt || null
        };
        items.push(newItem);
        saveDiscountInventory(items);
        return true;
      }
      
      // Remove discount from inventory (after use)
      function removeDiscountFromInventory(code) {
        let items = getDiscountInventory();
        items = items.filter(item => item.code !== code);
        saveDiscountInventory(items);
      }
      
      // Open inventory modal
      function openInventory() {
        const items = getDiscountInventory();
        const container = document.getElementById('inventory-items');
        
        if (items.length === 0) {
          container.innerHTML = '<p style="color:#666; font-style:italic; text-align:center; padding:30px 0;">No discount codes yet...<br><small>Earn codes from VIP, Class bonuses, Quests & AP Shop!</small></p>';
        } else {
          let html = '';
          
          // Group by type
          const typeOrder = ['vip', 'class', 'quest', 'shop', 'daily', 'general'];
          const typeLabels = {
            vip: 'üëë VIP REWARDS',
            class: '‚öîÔ∏è CLASS BONUSES', 
            quest: 'üìú QUEST REWARDS',
            shop: 'üõçÔ∏è AP SHOP',
            daily: 'üéÅ DAILY REWARDS',
            general: 'üéüÔ∏è OTHER'
          };
          
          typeOrder.forEach(type => {
            const typeItems = items.filter(item => item.type === type);
            if (typeItems.length > 0) {
              html += '<div style="margin-bottom:15px;">';
              html += '<div style="color:#888; font-size:11px; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:5px;">' + (typeLabels[type] || type.toUpperCase()) + '</div>';
              
              typeItems.forEach(item => {
                const date = new Date(item.addedAt).toLocaleDateString('en-US');
                html += '<div class="inv-item" style="cursor:pointer;" onclick="copyDiscountCode(\'' + item.code + '\')">';
                html += '<div style="font-size:28px; min-width:40px; text-align:center;">' + item.icon + '</div>';
                html += '<div class="inv-item-info">';
                html += '<div class="inv-item-name">' + item.name + '</div>';
                html += '<div style="color:var(--class-color); font-weight:bold; font-size:13px;">' + item.code + '</div>';
                html += '<div class="inv-item-date">' + item.discount + ' ‚Ä¢ Added: ' + date + '</div>';
                html += '</div>';
                html += '<button class="inv-item-btn" style="background:#2ecc71;" onclick="event.stopPropagation(); copyDiscountCode(\'' + item.code + '\')">üìã COPY</button>';
                html += '</div>';
              });
              html += '</div>';
            }
          });
          
          container.innerHTML = html;
        }
        
        document.getElementById('inventory-modal').style.display = 'flex';
      }
      
      function copyDiscountCode(code) {
        navigator.clipboard.writeText(code);
        showCustomAlert('üìã', 'CODE COPIED!', 'Code "' + code + '" copied to clipboard. Use at checkout!');
      }
      
      // Initialize default discounts based on VIP and Class
      function initializeDefaultDiscounts() {
        const savedClass = localStorage.getItem(KEY_CLASS);
        
        // Add Class discount if class is selected
        if (savedClass) {
          const classCode = savedClass.toUpperCase() + '_VIP';
          addDiscountToInventory({
            name: savedClass + ' Class Bonus',
            code: classCode,
            type: 'class',
            discount: '5% OFF',
            icon: savedClass === 'Warrior' ? '‚öîÔ∏è' : savedClass === 'Mage' ? 'üîÆ' : 'üèπ'
          });
        }
        
        // Add VIP discount based on VIP level (calculated from customer.total_spent)
        {% if customer %}
          {% assign customer_spent = customer.total_spent | divided_by: 100 %}
          {% assign vip_level = 0 %}
          {% if customer_spent >= 5000000 %}
            {% assign vip_level = 5 %}
          {% elsif customer_spent >= 3000000 %}
            {% assign vip_level = 4 %}
          {% elsif customer_spent >= 1500000 %}
            {% assign vip_level = 3 %}
          {% elsif customer_spent >= 700000 %}
            {% assign vip_level = 2 %}
          {% elsif customer_spent >= 500000 %}
            {% assign vip_level = 1 %}
          {% endif %}
          
          {% if vip_level > 0 %}
            addDiscountToInventory({
              name: 'VIP {{ vip_level }} Exclusive',
              code: 'VIP{{ vip_level }}_DISCOUNT',
              type: 'vip',
              discount: '{{ vip_level | times: 3 }}% OFF',
              icon: 'üëë'
            });
          {% endif %}
        {% endif %}
        
        updateInventoryCount();
      }
    </script>
  {% render 'rpg-quests' %}
  </body>
</html>
  
{% include 'gameball' %}