<!doctype html>
{% comment %} --- LOGIC T√çNH RANK & M√ÄU S·∫ÆC --- {% endcomment %}
{% assign current_spent = customer.total_spent | default: 0 %}
{% assign rpg_rank_title = "Tan Thu" %}
{% assign rpg_rank_color = "#999" %} 

{% if current_spent >= 30000000 %}
  {% assign rpg_rank_title = "GODSLAYER" %}
  {% assign rpg_rank_color = "#ffd700" %} <!-- V√†ng kim -->
{% elsif current_spent >= 18000000 %}
  {% assign rpg_rank_title = "MYTHIC" %}
  {% assign rpg_rank_color = "#00e5ff" %} <!-- Xanh Cyan -->
{% elsif current_spent >= 12000000 %}
  {% assign rpg_rank_title = "DRAGONBANE" %}
  {% assign rpg_rank_color = "#ff3d00" %} <!-- ƒê·ªè cam -->
{% elsif current_spent >= 8000000 %}
  {% assign rpg_rank_title = "VANGUARD" %}
  {% assign rpg_rank_color = "#d500f9" %} <!-- T√≠m -->
{% elsif current_spent >= 5000000 %}
  {% assign rpg_rank_title = "SHADOW" %}
  {% assign rpg_rank_color = "#aa00ff" %} <!-- T√≠m ƒë·∫≠m -->
{% elsif current_spent >= 2000000 %}
  {% assign rpg_rank_title = "HUNTER" %}
  {% assign rpg_rank_color = "#2979ff" %} <!-- Xanh d∆∞∆°ng -->
{% elsif current_spent >= 500000 %}
  {% assign rpg_rank_title = "WANDERER" %}
  {% assign rpg_rank_color = "#00e676" %} <!-- Xanh l√° -->
{% endif %}
<html class="no-js" lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">

    <!-- 1. FONT CH·ªÆ GAME RPG -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    <title>{{ page_title }}</title>

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {{ content_for_header }}

    <!-- 2. CSS RPG - FULL WIDTH & NEW MODALS -->
    <style>
      /* CSS CHO TAG RANK */
.rpg-rank-badge {
  font-size: 9px;            /* Ch·ªØ nh·ªè h∆°n t√™n Class */
  font-weight: 700;
  text-transform: uppercase;
  padding: 1px 5px;          /* Kho·∫£ng c√°ch trong vi·ªÅn */
  border: 1px solid;         /* Vi·ªÅn m·ªèng */
  border-radius: 2px;        /* Bo g√≥c nh·∫π */
  background: rgba(0, 0, 0, 0.4); /* N·ªÅn ƒëen m·ªù ƒë·ªÉ n·ªïi b·∫≠t ch·ªØ */
  letter-spacing: 0.5px;
  backdrop-filter: blur(2px);
  animation: glowPulse 3s infinite alternate; /* Hi·ªáu ·ª©ng nh·∫•p nh√°y nh·∫π */
}

/* Hi·ªáu ·ª©ng s√°ng nh·∫π */
@keyframes glowPulse {
  0% { opacity: 0.8; }
  100% { opacity: 1; text-shadow: 0 0 5px currentColor; }
}
      :root {
        --rpg-gold: #ffd700;
        --rpg-dark: #0a0a0c;
        --class-color: #ffd700; /* M·∫∑c ƒë·ªãnh */
      }

      /* FIX FULL WIDTH & BACKGROUND */
      body {
        background-color: var(--rpg-dark) !important;
        color: #e0e0e0 !important;
        font-family: 'Roboto', sans-serif;
        padding-top: 60px !important;
        overflow-x: hidden;
      }

      .page-width, .page-width-desktop {
        max-width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
        margin: 0 !important;
      }

      .gradient { background: transparent !important; }

      h1, h2, h3, h4, h5, h6, .h1, .h2 {
        font-family: 'Cinzel', serif !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #fff !important;
      }

      /* --- RPG HUD --- */
      #rpg-hud {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        background: rgba(10, 10, 12, 0.95);
        border-bottom: 2px solid var(--class-color);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 30px; z-index: 10000;
        box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        backdrop-filter: blur(5px); font-family: 'Cinzel', serif;
      }
      
      .hud-left { display: flex; align-items: center; gap: 15px; }
      .hud-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--class-color); object-fit: cover; }
      
      .hud-right { 
  display: flex; 
  align-items: center; 
  gap: 20px; 
  padding-right: 50px; /* <--- TH√äM D√íNG N√ÄY (TƒÉng s·ªë n√†y l√™n n·∫øu mu·ªën d·ªùi v√†o s√¢u h∆°n) */
}
      
      /* Thanh Ti·∫øn ƒê·ªô VIP */
      .vip-wrapper { text-align: right; }
      .vip-label { font-size: 14px; font-weight: bold; color: var(--class-color); }
      .xp-container { width: 150px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 2px; }
      .xp-fill { height: 100%; background: linear-gradient(90deg, var(--class-color), #fff); width: 0%; transition: width 1s ease-out; }
      
      /* ƒêi·ªÉm t√≠ch l≈©y Daily */
      .hud-ap { font-size: 12px; color: #a335ee; font-weight: bold; border: 1px solid #a335ee; padding: 2px 6px; border-radius: 4px; }
      .hud-ap:hover {
  background-color: #a335ee;
  color: #fff !important;
  box-shadow: 0 0 10px #a335ee;
  transition: 0.3s;
}
      /* --- HUD NAV LINKS --- */
      .hud-nav-link {
        display: flex; align-items: center; gap: 5px;
        color: #ffd700; font-size: 12px; font-weight: bold;
        text-decoration: none; padding: 5px 10px;
        border: 1px solid #ffd700; border-radius: 4px;
        transition: all 0.3s;
      }
      .hud-nav-link:hover {
        background: #ffd700; color: #000 !important;
        box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      }
      /* --- ICON T√öI ƒê·ªí (INVENTORY) --- */
      .hud-inventory-btn {
        font-size: 22px; cursor: pointer; position: relative;
        transition: transform 0.2s; padding: 5px;
      }
      .hud-inventory-btn:hover { transform: scale(1.15); }
      .inventory-count {
        position: absolute; top: -5px; right: -8px;
        background: #ff4d4d; color: #fff; font-size: 10px; font-weight: bold;
        min-width: 18px; height: 18px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        border: 2px solid #0a0a0c;
      }
      .inventory-count:empty, .inventory-count[data-count="0"] { display: none; }
      
      /* --- INVENTORY ITEMS --- */
      .inv-item {
        display: flex; align-items: center; gap: 15px;
        background: rgba(255,255,255,0.05); border: 1px solid #333;
        padding: 12px; border-radius: 8px; margin-bottom: 10px;
        transition: all 0.3s;
      }
      .inv-item:hover { border-color: #ffd700; background: rgba(255,215,0,0.1); }
      .inv-item-img { width: 50px; height: 50px; object-fit: contain; border-radius: 5px; }
      .inv-item-info { flex: 1; text-align: left; }
      .inv-item-name { font-weight: bold; color: #fff; font-size: 14px; }
      .inv-item-date { font-size: 11px; color: #888; }
      .inv-item-btn {
        background: linear-gradient(135deg, #ff0055, #ff4400);
        border: none; color: #fff; padding: 8px 15px; border-radius: 5px;
        cursor: pointer; font-weight: bold; font-size: 12px;
        transition: transform 0.2s;
      }
      .inv-item-btn:hover { transform: scale(1.05); }
      
      /* --- LOOTBOX OPEN MODAL --- */
      .lootbox-open-container {
        position: relative; z-index: 10; text-align: center;
        width: 100%; max-width: 500px; padding: 30px;
      }
      .lb-phase { display: flex; flex-direction: column; align-items: center; justify-content: center; }
      .lb-box-shake { width: 250px; height: 250px; object-fit: contain; }
      .lb-box-shake.shaking { animation: lbShake 0.4s infinite; }
      @keyframes lbShake { 0%,100%{transform:rotate(0)} 25%{transform:rotate(8deg)} 75%{transform:rotate(-8deg)} }
      .lb-status { color: #fff; font-size: 24px; margin-top: 20px; letter-spacing: 2px; }
      
      .lb-halo {
        position: absolute; width: 400px; height: 400px;
        background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
        animation: lbBreathe 2s infinite alternate;
      }
      @keyframes lbBreathe { from{transform:scale(1);opacity:0.5} to{transform:scale(1.1);opacity:0.8} }
      
      #lb-prize-img {
        width: 280px; height: 280px; object-fit: contain;
        filter: drop-shadow(0 0 20px gold);
        animation: lbZoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes lbZoomIn { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }
      
      .lb-prize-info { margin-top: 15px; }
      .lb-label { color: #aaa; font-size: 12px; letter-spacing: 2px; }
      #lb-prize-name { color: #ffd700; font-size: 28px; margin: 5px 0; font-weight: bold; }
      .lb-badge { background: #222; border: 1px solid #444; color: #fff; padding: 4px 12px; border-radius: 15px; font-size: 12px; display: inline-block; }
      
      /* --- ICON QU√Ä T·∫∂NG --- */
      .hud-gift-btn {
        font-size: 24px; cursor: pointer; position: relative;
        transition: transform 0.2s;
      }
      .hud-gift-btn:hover { transform: scale(1.2) rotate(-10deg); }
      .noti-dot {
        position: absolute; top: -2px; right: -2px; width: 10px; height: 10px;
        background: #ff4d4d; border-radius: 50%; border: 1px solid #fff;
        display: none; animation: pulse 1s infinite;
      }
      @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);} 70% {box-shadow: 0 0 0 5px rgba(255, 77, 77, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);} }

      /* --- GENERIC POPUP (THAY TH·∫æ ALERT) --- */
      .rpg-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 200000;
        display: none; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
      }
      .rpg-modal-box {
        background: #151515; border: 2px solid var(--class-color);
        padding: 30px; width: 350px; text-align: center; border-radius: 12px;
        color: #fff; box-shadow: 0 0 40px rgba(0,0,0,0.5);
        animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }
      @keyframes popIn { from {transform: scale(0.5); opacity: 0;} to {transform: scale(1); opacity: 1;} }

      .modal-icon-lg { font-size: 50px; margin-bottom: 15px; display: block; }
      .modal-title { color: var(--class-color); font-size: 20px; margin-bottom: 10px; font-weight: bold; }
      .modal-msg { font-size: 14px; color: #ccc; line-height: 1.5; margin-bottom: 20px; }
      
      .rpg-btn-primary {
        background: var(--class-color); color: #000; border: none;
        padding: 10px 25px; font-weight: bold; font-family: 'Cinzel', serif;
        cursor: pointer; width: 100%; text-transform: uppercase;
      }
      .rpg-btn-primary:hover { filter: brightness(1.2); }

      .code-display {
        background: #222; border: 1px dashed #fff; padding: 10px;
        font-size: 18px; color: #2ecc71; font-weight: bold; letter-spacing: 2px;
        margin-bottom: 15px; cursor: pointer; user-select: all;
      }
      /* --- POPUP CH·ªåN CLASS (RI√äNG) --- */
      #class-selection-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #000; z-index: 200005; display: none;
        flex-direction: column; justify-content: center; align-items: center;
      }
      .class-grid { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center;}
      .class-card {
        width: 240px; background: #151515; border: 1px solid #444; padding: 20px;
        text-align: center; cursor: pointer; transition: 0.3s; border-radius: 8px;
      }
      .class-card:hover { transform: scale(1.05); border-color: var(--hover-color); box-shadow: 0 0 20px var(--hover-color); }
      .class-img { font-size: 50px; margin-bottom: 15px; display: block; }
      .class-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; color: var(--hover-color); }
      .class-desc { font-size: 12px; color: #aaa; }

      /* Fix n√∫t b·∫•m Shopify */
      .button, .shopify-payment-button__button {
        border-radius: 4px !important; font-family: 'Cinzel', serif !important;
      }
    </style>
  </head>

  <body class="gradient">
    <!-- 3. RPG HUD (C·∫¨P NH·∫¨T VIP) -->
    <div id="rpg-hud">
<div class="hud-left">
  <!-- Avatar (Gi·ªØ nguy√™n) -->
  <img id="hud-avatar-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" width="40" height="40" alt="Avatar" class="hud-avatar">
  
  <div style="display: flex; flex-direction: column; justify-content: center; margin-left: 12px;">
    
    <!-- D√íNG 1: T√äN CLASS + TAG RANK -->
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
      <!-- T√™n Class -->
      <div style="font-weight:bold; color:var(--class-color); font-size: 1.2em; line-height: 1;" id="hud-class-name">NOVICE</div>
      
      <!-- Tag Rank (M·ªöI) -->
      <div class="rpg-rank-badge" style="
          color: {{ rpg_rank_color }}; 
          border-color: {{ rpg_rank_color }};
          box-shadow: 0 0 4px {{ rpg_rank_color }};
      ">
        {{ rpg_rank_title }}
      </div>
    </div>

    <!-- D√íNG 2: CODE BOX (Gi·ªØ nguy√™n nh∆∞ ·∫£nh c·ªßa b·∫°n) -->
    <div id="hud-class-code" style="
        font-size: 10px; 
        color: #ddd; 
        background: rgba(255,255,255,0.15); 
        padding: 2px 6px; 
        border-radius: 3px; 
        display: none; 
        cursor: pointer;
        width: fit-content;
    " onclick="copyToClipboard(this.innerText)">
      CODE: <span id="class-code-text">NONE</span>
    </div>

  </div>
</div>
      <div class="hud-right">
        <!-- NAV LINKS: LEADERBOARD -->
        <a href="/pages/leaderboard" class="hud-nav-link" title="B·∫£ng x·∫øp h·∫°ng">
          üèÜ <span class="mobile-hide">Rank</span>
        </a>
        
        <!-- ICON T√öI ƒê·ªí (INVENTORY) -->
        <div class="hud-inventory-btn" onclick="openInventory()" title="T√∫i ƒë·ªì">
          üéí
          <span class="inventory-count" id="inventory-count">0</span>
        </div>
        
        <!-- ICON NH·∫¨N QU√Ä -->
        <div class="hud-gift-btn" onclick="openDailyPopup()" title="ƒêi·ªÉm danh">
          üéÅ
          <div id="gift-noti" class="noti-dot"></div>
        </div>

        <div class="vip-wrapper">
          <div class="vip-label"><span id="hud-vip-rank">VIP 0</span></div>
          <div class="xp-container"><div class="xp-fill" id="hud-vip-bar"></div></div>
        </div>

        <div style="text-align: right;">
          <div style="color:var(--rpg-gold); font-weight: bold;">
            üí∞ <span id="hud-money">{{ customer.total_spent | money_without_currency | default: '0' }}</span> G
          </div>
          <!-- ƒêI·ªÇM AP (DAILY REWARD) -->
          <!-- N√öT AP (LINK ƒê·∫æN SHOP) -->
<a href="/pages/ap-shop" id="hud-ap-display" class="hud-ap" style="display:none; text-decoration:none; cursor:pointer;" title="B·∫•m ƒë·ªÉ v√†o Shop ƒë·ªïi qu√†">
  0 AP üõí
</a>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT SHOPIFY -->
    {% sections 'header-group' %}
    <main id="MainContent" class="content-for-layout" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>
    {% sections 'footer-group' %}

    <!-- 4. MODAL CH·ªåN CLASS -->
    <div id="class-selection-modal">
      <h1 style="color: #fff; font-size: 2.5rem; letter-spacing: 3px;">CH·ªåN H·ªÜ NH√ÇN V·∫¨T</h1>
      <p style="color: #888;">H√†nh tr√¨nh c·ªßa b·∫°n b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y</p>
      <div class="class-grid">
        <div class="class-card" style="--hover-color: #ff4d4d;" onclick="selectRPGClass('Warrior', '#ff4d4d')">
          <span class="class-img">‚öîÔ∏è</span><div class="class-title">WARRIOR</div><p class="class-desc">S·ª©c m·∫°nh & C·∫≠n chi·∫øn</p>
        </div>
        <div class="class-card" style="--hover-color: #a335ee;" onclick="selectRPGClass('Mage', '#a335ee')">
          <span class="class-img">üîÆ</span><div class="class-title">MAGE</div><p class="class-desc">Ph√©p thu·∫≠t & Tr√≠ tu·ªá</p>
        </div>
        <div class="class-card" style="--hover-color: #2ecc71;" onclick="selectRPGClass('Archer', '#2ecc71')">
          <span class="class-img">üèπ</span><div class="class-title">ARCHER</div><p class="class-desc">T·ªëc ƒë·ªô & Ch√≠nh x√°c</p>
        </div>
      </div>
    </div>

    <!-- 5. MODAL NH·∫¨N QU√Ä DAILY -->
    <div id="daily-reward-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span onclick="closeModal('daily-reward-modal')" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; color:#888;">‚úï</span>
        <h3 style="color:#ffd700; margin-top:0;">ƒêI·ªÇM DANH H√ÄNG NG√ÄY</h3>
        <p style="font-size:12px; color:#aaa;">Chu·ªói ng√†y: <span id="streak-day" style="color:#fff; font-weight:bold;">1</span></p>
        
        <div style="margin: 20px 0; font-size: 60px;">üéÅ</div>
        <div id="reward-info" style="margin-bottom:20px; font-weight:bold; font-size:1.1em;">
          Ph·∫ßn th∆∞·ªüng ƒëang ch·ªù...
        </div>

        <button id="btn-claim-reward" class="rpg-btn-primary" onclick="claimReward()">NH·∫¨N TH∆Ø·ªûNG</button>
        <p id="reward-timer" style="font-size:10px; color:#666; margin-top:10px;"></p>
      </div>
    </div>

    <!-- 6. MODAL T√öI ƒê·ªí (INVENTORY) -->
    <div id="inventory-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box" style="width: 450px; max-width: 95vw;">
        <span onclick="closeModal('inventory-modal')" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px; color:#888;">‚úï</span>
        <h3 style="color:#ffd700; margin-top:0;">üéí T√öI ƒê·ªí</h3>
        <p style="font-size:12px; color:#aaa; margin-bottom:20px;">C√°c lootbox ch∆∞a m·ªü s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</p>
        
        <div id="inventory-items" style="max-height: 300px; overflow-y: auto;">
          <p style="color:#666; font-style:italic;">T√∫i ƒë·ªì tr·ªëng...</p>
        </div>
      </div>
    </div>

    <!-- 7. MODAL M·ªû LOOTBOX -->
    <div id="lootbox-open-modal" class="rpg-modal-overlay" style="z-index:200001;">
      <div class="lootbox-open-container">
        <!-- Phase 1: X√°c nh·∫≠n m·ªü -->
        <div id="lb-phase-shake" class="lb-phase">
          <img id="lb-box-img" src="" class="lb-box-shake" alt="Lootbox">
          <div id="lb-confirm-text" style="text-align:center; margin-top:20px;">
            <p style="color:#aaa;">B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü h·ªôp n√†y?</p>
          </div>
          <div style="display:flex; gap:10px; margin-top:20px; justify-content:center;">
            <button class="rpg-btn-secondary" onclick="closeModal('lootbox-open-modal')" style="padding:10px 20px;">
              ‚ùå H·ª¶Y
            </button>
            <button id="lb-confirm-btn" class="rpg-btn-primary" onclick="confirmLootboxResult()" style="padding:10px 20px;">
              ‚úÖ M·ªû & THANH TO√ÅN
            </button>
          </div>
        </div>
        
        <!-- Phase 2: K·∫øt qu·∫£ (hi·ªán SAU khi thanh to√°n xong) -->
        <div id="lb-phase-result" class="lb-phase" style="display:none;">
          <div class="lb-halo"></div>
          <img id="lb-prize-img" src="" alt="Prize">
          <div class="lb-prize-info">
            <div class="lb-label">B·∫†N NH·∫¨N ƒê∆Ø·ª¢C</div>
            <h2 id="lb-prize-name">V·∫¨T PH·∫®M</h2>
            <div class="lb-badge" id="lb-prize-chance">T·ªâ l·ªá: 1%</div>
          </div>
          <button id="lb-close-btn" class="rpg-btn-primary" onclick="closeModal('lootbox-open-modal')" style="margin-top:20px;">
            üéâ TUY·ªÜT V·ªúI!
          </button>
        </div>
      </div>
    </div>

    <!-- 8. MODAL TH√îNG B√ÅO CHUNG (THAY TH·∫æ ALERT) -->
    <div id="custom-alert-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span class="modal-icon-lg" id="alert-icon">üéâ</span>
        <div class="modal-title" id="alert-title">TH√îNG B√ÅO</div>
        <div class="modal-msg" id="alert-msg">N·ªôi dung th√¥ng b√°o</div>
        <button class="rpg-btn-primary" onclick="closeModal('custom-alert-modal')">ƒê√ìNG</button>
      </div>
    </div>

    <!-- 9. MODAL NH·∫¨N GIFTCODE (THAY TH·∫æ PROMPT) -->
    <div id="giftcode-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span class="modal-icon-lg">üëë</span>
        <div class="modal-title" style="color:#2ecc71">JACKPOT!</div>
        <div class="modal-msg">Ch√∫c m·ª´ng b·∫°n nh·∫≠n ƒë∆∞·ª£c M√£ Gi·∫£m Gi√° ƒê·∫∑c Bi·ªát:</div>
        
        <div class="code-display" id="giftcode-display" onclick="copyToClipboard(this.innerText)">CODE_HERE</div>
        <p style="font-size:10px; color:#888; margin-bottom:15px;">(B·∫•m v√†o m√£ ƒë·ªÉ copy)</p>
        
        <button class="rpg-btn-primary" onclick="closeModal('giftcode-modal')">TUY·ªÜT V·ªúI</button>
      </div>
    </div>

    <!-- 8. K·ªäCH B·∫¢N JS (LOGIC M·ªöI) -->
    <script>
      // FIX L·ªñI NG√îN NG·ªÆ
      window.shopUrl = '{{ request.origin }}';
      window.routes = { cart_add_url: '{{ routes.cart_add_url }}', cart_change_url: '{{ routes.cart_change_url }}', cart_update_url: '{{ routes.cart_update_url }}', cart_url: '{{ routes.cart_url }}', predictive_search_url: '{{ routes.predictive_search_url }}' };
      window.cartStrings = { error: `L·ªói gi·ªè h√†ng`, quantityError: `S·ªë l∆∞·ª£ng kh√¥ng h·ª£p l·ªá` };
      window.variantStrings = { addToCart: `Th√™m v√†o gi·ªè`, soldOut: `H·∫øt h√†ng`, unavailable: `T·∫°m h·∫øt` };
      window.accessibilityStrings = { imageAvailable: `·∫¢nh s·∫µn s√†ng`, shareSuccess: `ƒê√£ copy link`, pauseSlideshow: `D·ª´ng`, playSlideshow: `Ch·∫°y` };

      // --- C·∫§U H√åNH H·ªÜ TH·ªêNG RPG ---
      const REAL_MONEY = {{ customer.total_spent | default: 0 }} / 100; // Ti·ªÅn n·∫°p th·∫≠t (VNƒê)
      
      // C·∫§U H√åNH C·∫§P VIP (THEO Y√äU C·∫¶U)
      const VIP_TIERS = [
        { name: 'VIP 0', min: 0 },
        { name: 'VIP 1', min: 500000 },
        { name: 'VIP 2', min: 5000000 },
        { name: 'VIP 3', min: 12000000 },
        { name: 'VIP 4', min: 20000000 },
        { name: 'VIP 5', min: 30000000 }
      ];

      // Config Qu√† T·∫∑ng Daily (Nh·∫≠n ƒëi·ªÉm AP ri√™ng)
      const DAILY_REWARDS = [
        {d:1, val: 50, type:'ap', label:'50 AP'},
        {d:2, val: 100, type:'ap', label:'100 AP'},
        {d:3, val: 150, type:'ap', label:'150 AP'},
        {d:4, val: 200, type:'ap', label:'200 AP'},
        {d:5, val: 300, type:'ap', label:'300 AP'},
        {d:6, val: 500, type:'ap', label:'500 AP'},
        {d:7, val: 'Cheap Product', type:'code', label:'GIFTCODE'}
      ];
      
      // Key l∆∞u tr·ªØ
      const KEY_DAY = 'rpg_daily_day';
      const KEY_TIME = 'rpg_daily_time';
      const KEY_AP = 'rpg_activity_points'; // L∆∞u ƒëi·ªÉm AP ri√™ng
      const KEY_INVENTORY = 'rpg_inventory'; // L∆∞u t√∫i ƒë·ªì (lootbox ch∆∞a m·ªü)

      // Bi·∫øn t·∫°m ƒë·ªÉ l∆∞u lootbox ƒëang m·ªü
      let currentOpeningLootbox = null;

      document.addEventListener("DOMContentLoaded", function() {
        initRPGSystem();
        checkRewardStatus();
        setInterval(checkRewardStatus, 1000);
        updateInventoryCount(); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng t√∫i ƒë·ªì
      });

      function initRPGSystem() {
        const savedClass = localStorage.getItem('rpg_class_name');
        const savedColor = localStorage.getItem('rpg_class_color');

        if (!savedClass) {
          document.getElementById('class-selection-modal').style.display = 'flex';
          document.body.style.overflow = 'hidden'; 
        } else {
          applyTheme(savedClass, savedColor);
        }
        
        // T√çNH VIP RANK V√Ä HI·ªÇN TH·ªä AP
        calculateVipRank();
        updateAPDisplay();
      }

      function selectRPGClass(className, colorHex) {
        localStorage.setItem('rpg_class_name', className);
        localStorage.setItem('rpg_class_color', colorHex);
        document.getElementById('class-selection-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
        
        // HI·ªÜN MODAL CH√ÄO M·ª™NG THAY V√å ALERT
        showCustomAlert('üëã', 'CH√ÄO M·ª™NG!', `B·∫°n ƒë√£ gia nh·∫≠p h·ªôi ${className}. Giao di·ªán ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô.`);
        
        setTimeout(() => location.reload(), 2000); // Reload sau 2s
      }

      function applyTheme(className, color) {
        document.documentElement.style.setProperty('--class-color', color);
        document.getElementById('hud-class-name').innerText = className.toUpperCase();
        
        const avatarMap = { 'Warrior': 'https://cdn-icons-png.flaticon.com/512/3408/3408593.png', 'Mage': 'https://cdn-icons-png.flaticon.com/512/3408/3408545.png', 'Archer': 'https://cdn-icons-png.flaticon.com/512/3408/3408605.png' };
        if(avatarMap[className]) document.getElementById('hud-avatar-img').src = avatarMap[className];

        const codeBox = document.getElementById('hud-class-code');
        const codeText = document.getElementById('class-code-text');
        if (className === 'Warrior') codeText.innerText = 'WARRIOR_VIP';
        else if (className === 'Mage') codeText.innerText = 'MAGE_VIP';
        else if (className === 'Archer') codeText.innerText = 'ARCHER_VIP';
        codeBox.style.display = 'inline-block';
      }

      // --- LOGIC T√çNH VIP THEO TI·ªÄN (VIP 1 - 5) ---
      function calculateVipRank() {
        let currentRank = 0;
        let nextRankMin = 500000;
        let rankName = 'NOVICE';

        // X√°c ƒë·ªãnh Rank
        for(let i = 0; i < VIP_TIERS.length; i++) {
          if(REAL_MONEY >= VIP_TIERS[i].min) {
            currentRank = i;
            rankName = VIP_TIERS[i].name;
            if (i < VIP_TIERS.length - 1) {
              nextRankMin = VIP_TIERS[i+1].min;
            } else {
              nextRankMin = REAL_MONEY; // Max level
            }
          }
        }

        // T√≠nh % thanh hi·ªÉn th·ªã (Ti·ªÅn hi·ªán t·∫°i / Ti·ªÅn c·∫ßn ƒë·ªÉ l√™n c·∫•p ti·∫øp theo)
        // Logic thanh: (Hi·ªán t·∫°i - M·ªëc hi·ªán t·∫°i) / (M·ªëc ti·∫øp theo - M·ªëc hi·ªán t·∫°i)
        let currentTierMin = VIP_TIERS[currentRank].min;
        let percent = 0;
        if (currentRank < 5) {
           percent = ((REAL_MONEY - currentTierMin) / (nextRankMin - currentTierMin)) * 100;
        } else {
           percent = 100; // Max VIP
        }

        document.getElementById('hud-vip-rank').innerText = rankName;
        document.getElementById('hud-vip-bar').style.width = percent + '%';
      }

      function updateAPDisplay() {
        const ap = parseInt(localStorage.getItem(KEY_AP) || 0);
        const apBox = document.getElementById('hud-ap-display');
        apBox.innerText = `‚ö° ${ap} AP`;
        apBox.style.display = 'inline-block';
      }

      // --- LOGIC NH·∫¨N QU√Ä ---
      function openDailyPopup() {
        document.getElementById('daily-reward-modal').style.display = 'flex';
        updatePopupUI();
      }

      function closeModal(id) {
        document.getElementById(id).style.display = 'none';
      }

      function showCustomAlert(icon, title, msg) {
        document.getElementById('alert-icon').innerText = icon;
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-msg').innerText = msg;
        document.getElementById('custom-alert-modal').style.display = 'flex';
      }

      function checkRewardStatus() {
        const last = parseInt(localStorage.getItem(KEY_TIME) || 0);
        const now = new Date().getTime();
        const COOLDOWN = 8640000; // 10s Test (S·ª≠a th√†nh 86400000 ch·∫°y th·∫≠t)
        
        const dot = document.getElementById('gift-noti');
        if(now - last > COOLDOWN) dot.style.display = 'block';
        else dot.style.display = 'none';
      }

      function updatePopupUI() {
        const day = parseInt(localStorage.getItem(KEY_DAY) || 1);
        const last = parseInt(localStorage.getItem(KEY_TIME) || 0);
        const now = new Date().getTime();
        const COOLDOWN = 10000;

        const reward = DAILY_REWARDS[day-1];
        document.getElementById('streak-day').innerText = day;
        
        let rewardText = reward.label;
        document.getElementById('reward-info').innerText = `Ph·∫ßn th∆∞·ªüng h√¥m nay: ${rewardText}`;

        const btn = document.getElementById('btn-claim-reward');
        const timer = document.getElementById('reward-timer');

        if(now - last < COOLDOWN) {
          btn.disabled = true;
          btn.innerText = "H√ÉY QUAY L·∫†I SAU";
          const diff = COOLDOWN - (now - last);
          timer.innerText = `Ch·ªù: ${Math.floor(diff/1000)} gi√¢y`;
        } else {
          btn.disabled = false;
          btn.innerText = "NH·∫¨N TH∆Ø·ªûNG";
          timer.innerText = "S·∫µn s√†ng!";
        }
      }

      function claimReward() {
        let day = parseInt(localStorage.getItem(KEY_DAY) || 1);
        if(day > 7) day = 1;
        
        const reward = DAILY_REWARDS[day-1];
        const now = new Date().getTime();

        closeModal('daily-reward-modal'); // T·∫Øt popup daily

        if(reward.type === 'ap') {
          // C·ªông ƒëi·ªÉm AP
          let currentAP = parseInt(localStorage.getItem(KEY_AP) || 0);
          let newAP = currentAP + reward.val;
          localStorage.setItem(KEY_AP, newAP);
          
          // HI·ªÜN MODAL CH√öC M·ª™NG (KH√îNG D√ôNG ALERT)
          showCustomAlert('‚ö°', 'NH·∫¨N TH√ÄNH C√îNG', `B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c ${reward.val} ƒëi·ªÉm ho·∫°t ƒë·ªông (AP).`);
          updateAPDisplay();
          
        } else if (reward.type === 'code') {
          // HI·ªÜN MODAL GIFTCODE (KH√îNG D√ôNG PROMPT)
          document.getElementById('giftcode-display').innerText = reward.val;
          document.getElementById('giftcode-modal').style.display = 'flex';
        }

        // L∆∞u
        localStorage.setItem(KEY_TIME, now);
        if(day < 7) localStorage.setItem(KEY_DAY, day + 1);
        else localStorage.setItem(KEY_DAY, 1);
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        // Hi·ªán th√¥ng b√°o nh·ªè ki·ªÉu Toast thay v√¨ alert
        showCustomAlert('üìã', 'ƒê√É SAO CH√âP', `M√£ "${text}" ƒë√£ l∆∞u v√†o b·ªô nh·ªõ t·∫°m.`);
      }

      // ==========================================
      // INVENTORY (T√öI ƒê·ªí) - LOOTBOX SYSTEM
      // ==========================================
      
      function getInventory() {
        return JSON.parse(localStorage.getItem(KEY_INVENTORY) || '[]');
      }
      
      function saveInventory(items) {
        localStorage.setItem(KEY_INVENTORY, JSON.stringify(items));
        updateInventoryCount();
      }
      
      function updateInventoryCount() {
        const items = getInventory();
        const countEl = document.getElementById('inventory-count');
        if (countEl) {
          countEl.innerText = items.length;
          countEl.setAttribute('data-count', items.length);
        }
      }
      
      // Th√™m lootbox v√†o t√∫i ƒë·ªì (g·ªçi t·ª´ trang product.lootbox)
      function addLootboxToInventory(lootboxData) {
        const items = getInventory();
        const newItem = {
          id: Date.now(),
          name: lootboxData.name || 'Mystery Lootbox',
          image: lootboxData.image || '',
          variantId: lootboxData.variantId,
          lootTable: lootboxData.lootTable || [],
          addedAt: new Date().toISOString()
        };
        items.push(newItem);
        saveInventory(items);
        showCustomAlert('üéí', 'ƒê√É TH√äM V√ÄO T√öI', `${newItem.name} ƒë√£ ƒë∆∞·ª£c th√™m v√†o t√∫i ƒë·ªì. V√†o t√∫i ƒë·ªì ƒë·ªÉ m·ªü!`);
      }
      
      // M·ªü modal t√∫i ƒë·ªì
      function openInventory() {
        const items = getInventory();
        const container = document.getElementById('inventory-items');
        
        if (items.length === 0) {
          container.innerHTML = '<p style="color:#666; font-style:italic; text-align:center; padding:30px 0;">T√∫i ƒë·ªì tr·ªëng...<br><small>Mua lootbox ƒë·ªÉ nh·∫≠n v√†o ƒë√¢y!</small></p>';
        } else {
          let html = '';
          items.forEach((item, index) => {
            const date = new Date(item.addedAt).toLocaleDateString('vi-VN');
            html += `
              <div class="inv-item">
                <img src="${item.image}" class="inv-item-img" alt="${item.name}">
                <div class="inv-item-info">
                  <div class="inv-item-name">${item.name}</div>
                  <div class="inv-item-date">Nh·∫≠n: ${date}</div>
                </div>
                <button class="inv-item-btn" onclick="openLootboxFromInventory(${index})">
                  üé∞ M·ªû
                </button>
              </div>
            `;
          });
          container.innerHTML = html;
        }
        
        document.getElementById('inventory-modal').style.display = 'flex';
      }
      
      // M·ªü lootbox t·ª´ t√∫i ƒë·ªì - CH·ªà X√ÅC NH·∫¨N, KH√îNG HI·ªÜN K·∫æT QU·∫¢
      function openLootboxFromInventory(index) {
        const items = getInventory();
        if (index >= items.length) return;
        
        currentOpeningLootbox = items[index];
        currentOpeningLootbox.inventoryIndex = index;
        closeModal('inventory-modal');
        
        // Hi·ªÉn th·ªã modal x√°c nh·∫≠n m·ªü
        const modal = document.getElementById('lootbox-open-modal');
        const phaseShake = document.getElementById('lb-phase-shake');
        const phaseResult = document.getElementById('lb-phase-result');
        const boxImg = document.getElementById('lb-box-img');
        
        // Reset UI - Hi·ªán confirm, kh√¥ng random
        modal.style.display = 'flex';
        phaseShake.style.display = 'flex';
        phaseResult.style.display = 'none';
        boxImg.src = currentOpeningLootbox.image;
        boxImg.classList.remove('shaking');
        
        // C·∫≠p nh·∫≠t text confirm
        document.getElementById('lb-confirm-text').innerHTML = `
          <p style="font-size:18px; margin-bottom:10px;">üéÅ <strong>${currentOpeningLootbox.name}</strong></p>
          <p style="color:#aaa;">B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü h·ªôp n√†y?</p>
          <p style="color:#ff9800; font-size:12px; margin-top:10px;">‚ö†Ô∏è K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c b·ªëc thƒÉm ng·∫´u nhi√™n SAU khi thanh to√°n!</p>
        `;
      }
      
      function getWeightedRandomLoot(items) {
        let total = items.reduce((sum, item) => sum + (item.chance || 0), 0);
        let random = Math.random() * total;
        let sum = 0;
        for (let i = 0; i < items.length; i++) {
          sum += items[i].chance || 0;
          if (random <= sum) return items[i];
        }
        return items[0];
      }
      
      // X√°c nh·∫≠n m·ªü lootbox - THANH TO√ÅN TR∆Ø·ªöC, RANDOM SAU
      function confirmLootboxResult() {
        if (!currentOpeningLootbox) return;
        
        // L∆∞u pending lootbox ƒë·ªÉ random SAU khi checkout xong
        const pendingData = {
          id: currentOpeningLootbox.id,
          name: currentOpeningLootbox.name,
          image: currentOpeningLootbox.image,
          lootTable: currentOpeningLootbox.lootTable,
          variantId: currentOpeningLootbox.variantId,
          timestamp: Date.now()
        };
        localStorage.setItem('pending_lootbox', JSON.stringify(pendingData));
        
        // X√≥a lootbox kh·ªèi inventory NGAY
        const items = getInventory();
        const index = items.findIndex(i => i.id === currentOpeningLootbox.id);
        if (index > -1) {
          items.splice(index, 1);
          saveInventory(items);
        }
        
        // Th√™m v√†o cart - CH∆ØA bi·∫øt k·∫øt qu·∫£
        fetch(window.Shopify.routes.root + 'cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            'items': [{
              'id': currentOpeningLootbox.variantId,
              'quantity': 1,
              'properties': {
                '_lootbox_pending': 'true',
                '_lootbox_name': currentOpeningLootbox.name
              }
            }]
          })
        })
        .then(response => {
          if (response.ok) {
            window.location.href = '/checkout';
          } else {
            // Rollback n·∫øu l·ªói
            localStorage.removeItem('pending_lootbox');
            const items = getInventory();
            items.push(currentOpeningLootbox);
            saveInventory(items);
            showCustomAlert('‚ùå', 'L·ªñI', 'Kh√¥ng th·ªÉ th√™m v√†o gi·ªè h√†ng. Vui l√≤ng th·ª≠ l·∫°i.');
          }
        })
        .catch(e => {
          console.error(e);
          localStorage.removeItem('pending_lootbox');
          showCustomAlert('‚ùå', 'L·ªñI K·∫æT N·ªêI', 'Vui l√≤ng ki·ªÉm tra m·∫°ng v√† th·ª≠ l·∫°i.');
        });
      }
      
      // Ki·ªÉm tra pending lootbox khi load trang (sau checkout)
      function checkPendingLootbox() {
        // C√ÅCH M·ªöI: Check URL param ?open_result=true
        const urlParams = new URLSearchParams(window.location.search);
        const shouldOpen = urlParams.get('open_result') === 'true';
        
        const pending = localStorage.getItem('pending_lootbox');
        if (!pending) return;
        
        try {
          const data = JSON.parse(pending);
          // Ch·ªâ x·ª≠ l√Ω n·∫øu pending < 10 ph√∫t (tr√°nh l·ªói c≈©)
          if (Date.now() - data.timestamp > 600000) {
            localStorage.removeItem('pending_lootbox');
            return;
          }
          
          // Ch·ªâ m·ªü k·∫øt qu·∫£ khi c√≥ URL param (t·ª´ thank you page redirect)
          if (shouldOpen && data.lootTable && data.lootTable.length > 0) {
            // X√≥a param kh·ªèi URL
            window.history.replaceState({}, '', window.location.pathname);
            
            // RANDOM K·∫æT QU·∫¢ NGAY B√ÇY GI·ªú
            const reward = getWeightedRandomLoot(data.lootTable);
            
            // X√≥a pending
            localStorage.removeItem('pending_lootbox');
            
            // Hi·ªán modal k·∫øt qu·∫£
            setTimeout(() => {
              showLootboxResult(data, reward);
            }, 500);
          }
        } catch(e) {
          console.error('Pending lootbox error:', e);
          localStorage.removeItem('pending_lootbox');
        }
      }
      
      // Hi·ªÉn th·ªã k·∫øt qu·∫£ lootbox sau khi thanh to√°n
      function showLootboxResult(lootbox, reward) {
        const modal = document.getElementById('lootbox-open-modal');
        const phaseShake = document.getElementById('lb-phase-shake');
        const phaseResult = document.getElementById('lb-phase-result');
        const boxImg = document.getElementById('lb-box-img');
        
        // Hi·ªán animation m·ªü
        modal.style.display = 'flex';
        phaseShake.style.display = 'flex';
        phaseResult.style.display = 'none';
        boxImg.src = lootbox.image;
        boxImg.classList.add('shaking');
        
        // Sau 2.5s hi·ªán k·∫øt qu·∫£
        setTimeout(() => {
          boxImg.classList.remove('shaking');
          phaseShake.style.display = 'none';
          phaseResult.style.display = 'flex';
          
          document.getElementById('lb-prize-img').src = reward.image || '';
          document.getElementById('lb-prize-name').innerText = reward.name;
          document.getElementById('lb-prize-chance').innerText = 'T·ªâ l·ªá: ' + reward.chance + '%';
          
          // ƒê·ªïi n√∫t th√†nh "ƒê√ìNG" thay v√¨ "X√ÅC NH·∫¨N"
          document.getElementById('lb-confirm-btn').innerText = 'üéâ TUY·ªÜT V·ªúI!';
          document.getElementById('lb-confirm-btn').onclick = function() {
            closeModal('lootbox-open-modal');
            showCustomAlert('üéä', 'CH√öC M·ª™NG!', `B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c: ${reward.name}`);
          };
        }, 2500);
      }
      
      // G·ªçi check khi load trang
      document.addEventListener('DOMContentLoaded', checkPendingLootbox);
    </script>
  {% render 'rpg-quests' %}
  </body>
</html>
  
{% include 'gameball' %}