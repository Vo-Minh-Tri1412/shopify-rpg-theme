<!doctype html>
<html class="no-js" lang="{{ request.locale.iso_code }}">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="theme-color" content="">
    <link rel="canonical" href="{{ canonical_url }}">

    <!-- 1. FONT CH·ªÆ GAME RPG -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}

    <title>{{ page_title }}</title>

    {%- render 'meta-tags' -%}
    {%- render 'stylesheets' -%}
    {%- render 'scripts' -%}
    {%- render 'theme-styles-variables' -%}
    {%- render 'color-schemes' -%}

    {{ content_for_header }}

    <!-- 2. CSS RPG CORE + FIX SEARCH -->
    <style>
      :root {
        --rpg-gold: #ffd700;
        --rpg-dark: #0a0a0c;
        --class-color: #ffd700; /* M·∫∑c ƒë·ªãnh */
      }

      /* FIX FULL WIDTH & BACKGROUND */
      body {
        background-color: var(--rpg-dark) !important;
        color: #e0e0e0 !important;
        font-family: 'Roboto', sans-serif;
        padding-top: 60px !important;
        overflow-x: hidden;
      }

      .page-width, .page-width-desktop {
        max-width: 100% !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
        margin: 0 !important;
      }

      .gradient { background: transparent !important; }

      h1, h2, h3, h4, h5, h6, .h1, .h2 {
        font-family: 'Cinzel', serif !important;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #fff !important;
      }
      
      /* --- FIX L·ªñI N√öT SEARCH KH√îNG B·∫§M ƒê∆Ø·ª¢C --- */
      /* ƒê·∫©y Header Shopify l√™n cao h∆°n HUD */
      .header-wrapper, .section-header, sticky-header {
        position: relative;
        z-index: 20000 !important; 
      }
      
      /* HUD cho ph√©p click xuy√™n qua ·ªü v√πng tr·ªëng */
      #rpg-hud {
        position: fixed; top: 0; left: 0; width: 100%; height: 60px;
        background: rgba(10, 10, 12, 0.95);
        border-bottom: 2px solid var(--class-color);
        display: flex; justify-content: space-between; align-items: center;
        padding: 0 30px; z-index: 10000;
        box-shadow: 0 5px 20px rgba(0,0,0,0.8);
        backdrop-filter: blur(5px); font-family: 'Cinzel', serif;
        pointer-events: none; /* QUAN TR·ªåNG: Cho ph√©p click xuy√™n qua thanh ƒëen */
      }
      
      /* C√°c n√∫t con trong HUD v·∫´n b·∫•m ƒë∆∞·ª£c */
      #rpg-hud > * { pointer-events: auto; }

      .hud-left { display: flex; align-items: center; gap: 15px; }
      .hud-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--class-color); object-fit: cover; }
      .hud-right { display: flex; align-items: center; gap: 20px; padding-right: 50px; }
      
      /* Thanh Ti·∫øn ƒê·ªô VIP */
      .vip-wrapper { text-align: right; }
      .vip-label { font-size: 14px; font-weight: bold; color: var(--class-color); }
      .xp-container { width: 150px; height: 6px; background: #333; border-radius: 3px; overflow: hidden; margin-top: 2px; }
      .xp-fill { height: 100%; background: linear-gradient(90deg, var(--class-color), #fff); width: 0%; transition: width 1s ease-out; }
      
      /* Daily Activity Points */
      .hud-ap { font-size: 12px; color: #a335ee; font-weight: bold; border: 1px solid #a335ee; padding: 2px 6px; border-radius: 4px; }
      .hud-ap:hover { background-color: #a335ee; color: #fff !important; box-shadow: 0 0 10px #a335ee; transition: 0.3s; }

      /* HUD Icons */
      .hud-nav-link { display: flex; align-items: center; gap: 5px; color: #ffd700; font-size: 12px; font-weight: bold; text-decoration: none; padding: 5px 10px; border: 1px solid #ffd700; border-radius: 4px; transition: all 0.3s; }
      .hud-nav-link:hover { background: #ffd700; color: #000 !important; box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
      
      .hud-inventory-btn, .hud-gift-btn { font-size: 22px; cursor: pointer; position: relative; transition: transform 0.2s; padding: 5px; }
      .hud-inventory-btn:hover, .hud-gift-btn:hover { transform: scale(1.15); }
      
      .inventory-count { position: absolute; top: -5px; right: -8px; background: #ff4d4d; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #0a0a0c; }
      .inventory-count:empty, .inventory-count[data-count="0"] { display: none; }
      
      .noti-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: #ff4d4d; border-radius: 50%; border: 1px solid #fff; display: none; animation: pulse 1s infinite; }
      @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 77, 77, 0.7);} 70% {box-shadow: 0 0 0 5px rgba(255, 77, 77, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 77, 77, 0);} }

      /* Modals Overlay */
      .rpg-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 200000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
      .rpg-modal-box { background: #151515; border: 2px solid var(--class-color); padding: 30px; width: 350px; text-align: center; border-radius: 12px; color: #fff; box-shadow: 0 0 40px rgba(0,0,0,0.5); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
      @keyframes popIn { from {transform: scale(0.5); opacity: 0;} to {transform: scale(1); opacity: 1;} }

      .modal-icon-lg { font-size: 50px; margin-bottom: 15px; display: block; }
      .modal-title { color: var(--class-color); font-size: 20px; margin-bottom: 10px; font-weight: bold; }
      .modal-msg { font-size: 14px; color: #ccc; line-height: 1.5; margin-bottom: 20px; }
      
      .rpg-btn-primary { background: var(--class-color); color: #000; border: none; padding: 10px 25px; font-weight: bold; font-family: 'Cinzel', serif; cursor: pointer; width: 100%; text-transform: uppercase; }
      .rpg-btn-primary:hover { filter: brightness(1.2); }

      .code-display { background: #222; border: 1px dashed #fff; padding: 10px; font-size: 18px; color: #2ecc71; font-weight: bold; letter-spacing: 2px; margin-bottom: 15px; cursor: pointer; user-select: all; }
      
      /* Inventory Items */
      .inv-item { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 12px; border-radius: 8px; margin-bottom: 10px; transition: all 0.3s; }
      .inv-item:hover { border-color: #ffd700; background: rgba(255,215,0,0.1); }
      .inv-item-info { flex: 1; text-align: left; }
      .inv-item-name { font-weight: bold; color: #fff; font-size: 14px; }
      .inv-item-btn { background: linear-gradient(135deg, #ff0055, #ff4400); border: none; color: #fff; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; }

      /* Rank Badge */
      .rpg-rank-badge { font-size: 9px; font-weight: 700; text-transform: uppercase; padding: 1px 5px; border: 1px solid; border-radius: 2px; background: rgba(0, 0, 0, 0.4); letter-spacing: 0.5px; backdrop-filter: blur(2px); animation: glowPulse 3s infinite alternate; }
      @keyframes glowPulse { 0% { opacity: 0.8; } 100% { opacity: 1; text-shadow: 0 0 5px currentColor; } }
      
      /* Class Selection */
      #class-selection-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 200005; display: none; flex-direction: column; justify-content: center; align-items: center; }
      .class-grid { display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap; justify-content: center;}
      .class-card { width: 240px; background: #151515; border: 1px solid #444; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; border-radius: 8px; }
      .class-card:hover { transform: scale(1.05); border-color: var(--hover-color); box-shadow: 0 0 20px var(--hover-color); }
      .class-img { font-size: 50px; margin-bottom: 15px; display: block; }
      .class-title { font-size: 20px; font-weight: bold; margin-bottom: 5px; color: var(--hover-color); }
      .class-desc { font-size: 12px; color: #aaa; }

      /* Buttons & Inputs */
      .button, .btn, .shopify-payment-button__button { border: 2px solid var(--class-color) !important; box-shadow: 0 0 8px rgba(255,215,0, 0.3); transition: 0.3s; }
      input[type="text"], input[type="email"], input[type="password"] { border: 1px solid var(--class-color) !important; background: rgba(0,0,0,0.5) !important; color: #fff !important; }
    </style>

    {% comment %} --- LOGIC T√çNH RANK & M√ÄU S·∫ÆC (LIQUID) --- {% endcomment %}
    {% assign current_spent = customer.total_spent | default: 0 %}
    {% assign rpg_rank_title = "Tan Thu" %}
    {% assign rpg_rank_color = "#999" %} 

    {% if current_spent >= 30000000 %}
      {% assign rpg_rank_title = "GODSLAYER" %}{% assign rpg_rank_color = "#ffd700" %}
    {% elsif current_spent >= 18000000 %}
      {% assign rpg_rank_title = "MYTHIC" %}{% assign rpg_rank_color = "#00e5ff" %}
    {% elsif current_spent >= 12000000 %}
      {% assign rpg_rank_title = "DRAGONBANE" %}{% assign rpg_rank_color = "#ff3d00" %}
    {% elsif current_spent >= 8000000 %}
      {% assign rpg_rank_title = "VANGUARD" %}{% assign rpg_rank_color = "#d500f9" %}
    {% elsif current_spent >= 5000000 %}
      {% assign rpg_rank_title = "SHADOW" %}{% assign rpg_rank_color = "#aa00ff" %}
    {% elsif current_spent >= 2000000 %}
      {% assign rpg_rank_title = "HUNTER" %}{% assign rpg_rank_color = "#2979ff" %}
    {% elsif current_spent >= 500000 %}
      {% assign rpg_rank_title = "WANDERER" %}{% assign rpg_rank_color = "#00e676" %}
    {% endif %}
  </head>

  <body class="gradient">
    
    <!-- 3. RPG HUD (CLEAN & FIXED) -->
    <div id="rpg-hud">
      <div class="hud-left">
        <img id="hud-avatar-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" width="40" height="40" alt="Avatar" class="hud-avatar">
        <div style="display: flex; flex-direction: column; justify-content: center; margin-left: 12px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
            <div style="font-weight:bold; color:var(--class-color); font-size: 1.2em; line-height: 1;" id="hud-class-name">Welcome</div>
            <div class="rpg-rank-badge" style="color: {{ rpg_rank_color }}; border-color: {{ rpg_rank_color }}; box-shadow: 0 0 4px {{ rpg_rank_color }};">
              {{ rpg_rank_title }}
            </div>
          </div>
          <div id="hud-class-code" style="font-size: 10px; color: #ddd; background: rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 3px; display: none; cursor: pointer; width: fit-content;" onclick="copyToClipboard(this.innerText)">
            CODE: <span id="class-code-text">NONE</span>
          </div>
        </div>
      </div>

      <div class="hud-right">
        <!-- LINKS -->
        <a href="/pages/leaderboard" class="hud-nav-link" title="Leaderboard">üèÜ Rank</a>
        <a href="/pages/quest-board" class="hud-nav-link" title="Archivement">üìú Achv</a>
        <a href="/pages/gold-shop" class="hud-nav-link" title="HALL OF GLORY" style="color: #ffd700;">ü™ô GLORY</a>
        <a href="/pages/ap-shop" class="hud-nav-link" title="AP Shop">üõçÔ∏è Shop</a>
        
        <!-- ICONS -->
        <div class="hud-inventory-btn" onclick="openInventory()" title="My Codes">üéüÔ∏è<span class="inventory-count" id="inventory-count">0</span></div>
        <div class="hud-gift-btn" onclick="openDailyPopup()" title="Daily Reward">üéÅ<div id="gift-noti" class="noti-dot"></div></div>

        <div class="vip-wrapper">
          <div class="vip-label"><span id="hud-vip-rank">{{ rpg_rank_title }}</span></div>
          <div class="xp-container"><div class="xp-fill" id="hud-vip-bar"></div></div>
        </div>

        <div style="text-align: right;">
          <a href="/pages/gold-shop" style="color:#ffd700; font-weight: bold; text-decoration:none; display:block; margin-bottom:3px;">ü™ô <span id="hud-gold-display">0</span> Gold</a>
          <a href="/pages/ap-shop" id="hud-ap-display" class="hud-ap" style="display:none; text-decoration:none; cursor:pointer; font-size:12px;">‚ö° 0 AP üõí</a>
        </div>
      </div>
    </div>

    <!-- MAIN SHOPIFY CONTENT -->
    {% sections 'header-group' %}
    <main id="MainContent" class="content-for-layout" role="main" tabindex="-1">
      {{ content_for_layout }}
    </main>
    {% sections 'footer-group' %}

    <!-- MODALS SECTION -->
    <div id="class-selection-modal">
      <h1 style="color: #fff; font-size: 2.5rem; letter-spacing: 3px;">CHOOSE YOUR CLASS</h1>
      <div class="class-grid">
        <div class="class-card" style="--hover-color: #ff4d4d;" onclick="selectRPGClass('Warrior', '#ff4d4d')"><span class="class-img">‚öîÔ∏è</span><div class="class-title">WARRIOR</div></div>
        <div class="class-card" style="--hover-color: #a335ee;" onclick="selectRPGClass('Mage', '#a335ee')"><span class="class-img">üîÆ</span><div class="class-title">MAGE</div></div>
        <div class="class-card" style="--hover-color: #2ecc71;" onclick="selectRPGClass('Archer', '#2ecc71')"><span class="class-img">üèπ</span><div class="class-title">ARCHER</div></div>
      </div>
    </div>

    <div id="daily-reward-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span onclick="closeModal('daily-reward-modal')" style="position:absolute; top:10px; right:15px; cursor:pointer;">‚úï</span>
        <h3 style="color:#ffd700;">DAILY CHECK-IN</h3>
        <p>Streak: <span id="streak-day" style="color:#fff; font-weight:bold;">1</span></p>
        <div style="margin: 20px 0; font-size: 60px;">üéÅ</div>
        <div id="reward-info" style="margin-bottom:20px; font-weight:bold;">Reward waiting...</div>
        <button id="btn-claim-reward" class="rpg-btn-primary" onclick="claimReward()">CLAIM REWARD</button>
        <p id="reward-timer" style="font-size:10px; color:#666; margin-top:10px;"></p>
      </div>
    </div>

    <div id="inventory-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box" style="width: 500px;">
        <span onclick="closeModal('inventory-modal')" style="position:absolute; top:10px; right:15px; cursor:pointer;">‚úï</span>
        <h3 style="color:#ffd700;">üéüÔ∏è MY CODES</h3>
        <div id="inventory-items" style="max-height: 350px; overflow-y: auto;"></div>
      </div>
    </div>

    <div id="custom-alert-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span class="modal-icon-lg" id="alert-icon">üéâ</span>
        <div class="modal-title" id="alert-title">NOTIFICATION</div>
        <div class="modal-msg" id="alert-msg">Message content</div>
        <button class="rpg-btn-primary" onclick="closeModal('custom-alert-modal')">CLOSE</button>
      </div>
    </div>

    <div id="giftcode-modal" class="rpg-modal-overlay">
      <div class="rpg-modal-box">
        <span class="modal-icon-lg">üëë</span>
        <div class="modal-title" style="color:#2ecc71">JACKPOT!</div>
        <div class="modal-msg">You received a Discount Code:</div>
        <div class="code-display" id="giftcode-display" onclick="copyToClipboard(this.innerText)">CODE_HERE</div>
        <button class="rpg-btn-primary" onclick="closeModal('giftcode-modal')">AWESOME</button>
      </div>
    </div>

    <!-- JS LOGIC -->
    <script>
      // FIX LANGUAGE
      window.shopUrl = '{{ request.origin }}';
      window.routes = { cart_add_url: '{{ routes.cart_add_url }}', cart_change_url: '{{ routes.cart_change_url }}', cart_update_url: '{{ routes.cart_update_url }}', cart_url: '{{ routes.cart_url }}', predictive_search_url: '{{ routes.predictive_search_url }}' };
      window.cartStrings = { error: `Cart error`, quantityError: `Invalid quantity` };
      window.variantStrings = { addToCart: `Add to cart`, soldOut: `Sold out`, unavailable: `Unavailable` };
      window.accessibilityStrings = { imageAvailable: `Image available`, shareSuccess: `Link copied`, pauseSlideshow: `Pause`, playSlideshow: `Play` };

      // CONFIG
      const REAL_MONEY = {{ customer.total_spent | default: 0 }} / 100;
      
      const VIP_TIERS = [
        { name: 'WANDERER', min: 0 },
        { name: 'WANDERER', min: 500000 },
        { name: 'HUNTER', min: 2000000 },
        { name: 'SHADOW', min: 5000000 },
        { name: 'VANGUARD', min: 8000000 },
        { name: 'DRAGONBANE', min: 12000000 },
        { name: 'MYTHIC', min: 18000000 },
        { name: 'GODSLAYER', min: 30000000 }
      ];

      const DAILY_REWARDS = [
        {d:1, val: 50, type:'ap', label:'50 AP'},
        {d:2, val: 100, type:'ap', label:'100 AP'},
        {d:3, val: 150, type:'ap', label:'150 AP'},
        {d:4, val: 200, type:'ap', label:'200 AP'},
        {d:5, val: 300, type:'ap', label:'300 AP'},
        {d:6, val: 500, type:'ap', label:'500 AP'},
        {d:7, val: 'Cheap Product', type:'code', label:'GIFTCODE'}
      ];
      
      // STORAGE KEYS
      const KEY_DAY = 'rpg_daily_day';
      const KEY_TIME = 'rpg_daily_time';
      const KEY_AP = 'rpg_activity_points';
      const KEY_INVENTORY = 'rpg_discount_codes';
      const KEY_CLASS = 'rpg_class_name';
      const KEY_COLOR = 'rpg_class_color';
      const KEY_GOLD = 'rpg_gold';

      document.addEventListener("DOMContentLoaded", function() {
        initRPGSystem();
        checkRewardStatus();
        setInterval(checkRewardStatus, 1000);
        updateInventoryCount();
      });

      function initRPGSystem() {
        const savedClass = localStorage.getItem(KEY_CLASS);
        const savedColor = localStorage.getItem(KEY_COLOR);

        if (!savedClass) {
          document.getElementById('class-selection-modal').style.display = 'flex';
          document.body.style.overflow = 'hidden'; 
        } else {
          applyTheme(savedClass, savedColor);
        }
        
        calculateVipRank();
        updateAPDisplay();
        updateGoldDisplay();
        initializeDefaultDiscounts();
      }

      function selectRPGClass(className, colorHex) {
        localStorage.setItem(KEY_CLASS, className);
        localStorage.setItem(KEY_COLOR, colorHex);
        document.getElementById('class-selection-modal').style.display = 'none';
        document.body.style.overflow = 'auto';
        showCustomAlert('üëã', 'WELCOME!', `You have joined the ${className} class!`);
        setTimeout(() => location.reload(), 2000);
      }

      function applyTheme(className, color) {
        document.documentElement.style.setProperty('--class-color', color);
        document.getElementById('hud-class-name').innerText = className.toUpperCase();
        
        const avatarMap = { 'Warrior': 'https://cdn-icons-png.flaticon.com/512/3408/3408593.png', 'Mage': 'https://cdn-icons-png.flaticon.com/512/3408/3408545.png', 'Archer': 'https://cdn-icons-png.flaticon.com/512/3408/3408605.png' };
        if(avatarMap[className]) document.getElementById('hud-avatar-img').src = avatarMap[className];

        const codeBox = document.getElementById('hud-class-code');
        const codeText = document.getElementById('class-code-text');
        if (className === 'Warrior') codeText.innerText = 'WARRIOR_VIP';
        else if (className === 'Mage') codeText.innerText = 'MAGE_VIP';
        else if (className === 'Archer') codeText.innerText = 'ARCHER_VIP';
        codeBox.style.display = 'inline-block';
      }

      // VIP CALCULATOR
      function calculateVipRank() {
        let currentRank = 0;
        let nextRankMin = 500000;
        
        for(let i = 0; i < VIP_TIERS.length; i++) {
          if(REAL_MONEY >= VIP_TIERS[i].min) {
            currentRank = i;
            if (i < VIP_TIERS.length - 1) nextRankMin = VIP_TIERS[i+1].min;
            else nextRankMin = REAL_MONEY;
          }
        }
        let currentTierMin = VIP_TIERS[currentRank].min;
        let percent = currentRank < 7 ? ((REAL_MONEY - currentTierMin) / (nextRankMin - currentTierMin)) * 100 : 100;
        document.getElementById('hud-vip-bar').style.width = percent + '%';
      }

      function updateAPDisplay() {
        const ap = parseInt(localStorage.getItem(KEY_AP) || 0);
        document.getElementById('hud-ap-display').innerText = `‚ö° ${ap} AP`;
        document.getElementById('hud-ap-display').style.display = 'inline-block';
      }
      
      function updateGoldDisplay() {
        const gold = parseInt(localStorage.getItem(KEY_GOLD) || 0);
        const goldEl = document.getElementById('hud-gold-display');
        if (goldEl) goldEl.innerText = gold.toLocaleString();
      }

      // DAILY REWARD LOGIC
      function openDailyPopup() {
        document.getElementById('daily-reward-modal').style.display = 'flex';
        updatePopupUI();
      }

      function closeModal(id) { document.getElementById(id).style.display = 'none'; }
      function showCustomAlert(icon, title, msg) {
        document.getElementById('alert-icon').innerText = icon;
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-msg').innerText = msg;
        document.getElementById('custom-alert-modal').style.display = 'flex';
      }

      function checkRewardStatus() {
        const last = parseInt(localStorage.getItem(KEY_TIME) || 0);
        const now = new Date().getTime();
        const COOLDOWN = 10000; // Testing 10s
        const dot = document.getElementById('gift-noti');
        if(now - last > COOLDOWN) dot.style.display = 'block';
        else dot.style.display = 'none';
      }

      function updatePopupUI() {
        const day = parseInt(localStorage.getItem(KEY_DAY) || 1);
        const last = parseInt(localStorage.getItem(KEY_TIME) || 0);
        const now = new Date().getTime();
        const COOLDOWN = 10000;
        const reward = DAILY_REWARDS[day-1];
        document.getElementById('streak-day').innerText = day;
        document.getElementById('reward-info').innerText = `Reward: ${reward.label}`;
        const btn = document.getElementById('btn-claim-reward');
        const timer = document.getElementById('reward-timer');

        if(now - last < COOLDOWN) {
          btn.disabled = true;
          btn.innerText = "WAIT";
          timer.innerText = `Wait: ${Math.floor((COOLDOWN - (now - last))/1000)}s`;
        } else {
          btn.disabled = false;
          btn.innerText = "CLAIM REWARD";
          timer.innerText = "Ready!";
        }
      }

      function claimReward() {
        let day = parseInt(localStorage.getItem(KEY_DAY) || 1);
        if(day > 7) day = 1;
        const reward = DAILY_REWARDS[day-1];
        const now = new Date().getTime();
        closeModal('daily-reward-modal');

        if(reward.type === 'ap') {
          let currentAP = parseInt(localStorage.getItem(KEY_AP) || 0);
          localStorage.setItem(KEY_AP, currentAP + reward.val);
          showCustomAlert('‚ö°', 'CLAIMED', `Received ${reward.val} AP`);
          updateAPDisplay();
        } else if (reward.type === 'code') {
          document.getElementById('giftcode-display').innerText = reward.val;
          document.getElementById('giftcode-modal').style.display = 'flex';
        }
        localStorage.setItem(KEY_TIME, now);
        if(day < 7) localStorage.setItem(KEY_DAY, day + 1);
        else localStorage.setItem(KEY_DAY, 1);
      }

      function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
        showCustomAlert('üìã', 'COPIED', `Code "${text}" copied!`);
      }

      // INVENTORY SYSTEM
      function getDiscountInventory() { return JSON.parse(localStorage.getItem(KEY_INVENTORY) || '[]'); }
      function saveDiscountInventory(items) { localStorage.setItem(KEY_INVENTORY, JSON.stringify(items)); updateInventoryCount(); }
      function updateInventoryCount() {
        const items = getDiscountInventory();
        const countEl = document.getElementById('inventory-count');
        if (countEl) { countEl.innerText = items.length; countEl.setAttribute('data-count', items.length); }
      }
      function addDiscountToInventory(d) {
        const items = getDiscountInventory();
        if (items.some(item => item.code === d.code)) return false;
        items.push({...d, id: Date.now(), addedAt: new Date().toISOString()});
        saveDiscountInventory(items);
        return true;
      }
      
      function openInventory() {
        const items = getDiscountInventory();
        const container = document.getElementById('inventory-items');
        if (items.length === 0) {
          container.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No codes yet.</p>';
        } else {
          let html = '';
          items.forEach(item => {
            html += `<div class="inv-item" onclick="copyToClipboard('${item.code}')">
              <div style="font-size:24px;">${item.icon}</div>
              <div class="inv-item-info"><div class="inv-item-name">${item.name}</div><div style="color:var(--class-color);">${item.code}</div></div>
              <button class="inv-item-btn">COPY</button>
            </div>`;
          });
          container.innerHTML = html;
        }
        document.getElementById('inventory-modal').style.display = 'flex';
      }

      function initializeDefaultDiscounts() {
        const savedClass = localStorage.getItem(KEY_CLASS);
        if (savedClass) addDiscountToInventory({ name: savedClass + ' Class Bonus', code: savedClass.toUpperCase() + '_VIP', type: 'class', discount: '5%', icon: savedClass === 'Warrior' ? '‚öîÔ∏è' : savedClass === 'Mage' ? 'üîÆ' : 'üèπ' });
      }
    </script>
    
    {% include 'gameball' %}
  </body>
</html>