<!-- ========================================== -->
<!-- DAILY QUEST SYSTEM - RPG STYLE -->
<!-- Code updated for: Cheap Product Discount -->
<!-- ========================================== -->

<div class="daily-quest-wrapper">
  <!-- ·∫¢nh n·ªÅn l·∫•y t·ª´ c√†i ƒë·∫∑t ho·∫∑c d√πng ·∫£nh placeholder -->
  <div class="quest-container" style="background-image: url('{{ section.settings.background_image | image_url }}');">
    
    <div class="quest-content">
      <h2 class="quest-title">‚öîÔ∏è ƒêI·ªÇM DANH H√ÄNG NG√ÄY ‚öîÔ∏è</h2>
      <p class="quest-subtitle">ƒêƒÉng nh·∫≠p li√™n t·ª•c 7 ng√†y ƒë·ªÉ nh·∫≠n ƒêi·ªÉm AP ƒë·ªïi qu√†</p>

      <!-- L∆∞·ªõi hi·ªÉn th·ªã 7 ng√†y (JS s·∫Ω v·∫Ω v√†o ƒë√¢y) -->
      <div class="quest-grid" id="quest-grid"></div>

      <!-- N√∫t b·∫•m v√† B·ªô ƒë·∫øm ng∆∞·ª£c -->
      <div class="quest-actions">
        <button id="quest-claim-btn" class="quest-btn" onclick="claimDailyReward()">ƒêANG T·∫¢I D·ªÆ LI·ªÜU...</button>
        <p id="next-claim-timer">Ki·ªÉm tra tr·∫°ng th√°i...</p>
      </div>
    </div>
  </div>
</div>

<!-- POPUP NH·∫¨N TH∆Ø·ªûNG (MODAL) -->
<div id="reward-modal" class="rpg-modal">
  <div class="rpg-modal-content">
    <h2 class="modal-title">üéâ CH√öC M·ª™NG!</h2>
    <div id="reward-icon" class="modal-icon">üéÅ</div>
    <p id="reward-msg" class="modal-msg">B·∫°n nh·∫≠n ƒë∆∞·ª£c qu√†</p>
    
    <!-- H·ªôp hi·ªÉn th·ªã Giftcode -->
    <div id="reward-code-box" class="code-box" onclick="copyGiftCode()">
      <span id="giftcode-text">CODE</span> <span style="font-size:12px; margin-left:5px;">(B·∫•m ƒë·ªÉ copy)</span>
    </div>
    
    <button class="modal-btn" onclick="closeRewardModal()">NH·∫¨N NGAY</button>
  </div>
</div>

<!-- ========================================== -->
<!-- PH·∫¶N 2: CSS (GIAO DI·ªÜN) -->
<!-- ========================================== -->
<style>
  /* Wrapper chung */
  .daily-quest-wrapper {
    padding: 40px 20px;
    background: #0a0a0c; /* N·ªÅn ƒëen t·ªáp v·ªõi theme */
    font-family: 'Cinzel', serif;
    color: #fff;
  }

  /* Khung ch·ª©a n·ªôi dung ch√≠nh */
  .quest-container { 
    max-width: 900px; 
    margin: 0 auto; 
    background-color: #111;
    background-size: cover; 
    background-position: center; 
    border: 2px solid #333; 
    border-radius: 12px; 
    overflow: hidden; 
    position: relative;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
  }

  /* L·ªõp ph·ªß t·ªëi ƒë·ªÉ ch·ªØ d·ªÖ ƒë·ªçc */
  .quest-container::before { 
    content:''; position:absolute; top:0; left:0; width:100%; height:100%; 
    background: linear-gradient(to bottom, rgba(0,0,0,0.6), rgba(0,0,0,0.9)); 
  }

  .quest-content { position: relative; z-index: 2; padding: 40px; text-align: center; }
  
  .quest-title { 
    color: #ffd700; text-shadow: 0 0 15px #ffd700; 
    font-size: 2em; margin: 0 0 10px 0; font-weight: bold; 
  }
  .quest-subtitle { color: #ccc; margin-bottom: 30px; font-family: 'Roboto', sans-serif; font-size: 14px; }

  /* L∆∞·ªõi 7 ng√†y */
  .quest-grid { 
    display: grid; 
    grid-template-columns: repeat(7, 1fr); 
    gap: 10px; 
    margin-bottom: 30px; 
  }
  
  /* Responsive Mobile: Chia l√†m 2 d√≤ng */
  @media(max-width: 768px) { 
    .quest-grid { grid-template-columns: repeat(4, 1fr); }
    .quest-grid .day-card:nth-child(n+5) { grid-column: span 1; }
    /* CƒÉn gi·ªØa d√≤ng 2 n·∫øu c·∫ßn */
  }

  /* Th·∫ª ng√†y (Card) */
  .day-card { 
    background: rgba(255,255,255,0.05); 
    border: 1px solid #444; 
    padding: 15px 5px; 
    border-radius: 8px; 
    position: relative; 
    transition: 0.3s;
  }

  /* Tr·∫°ng th√°i th·∫ª */
  .day-card.active { 
    border-color: #ffd700; 
    background: rgba(255, 215, 0, 0.1);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); 
    transform: scale(1.05); 
    z-index: 2;
  }
  .day-card.claimed { 
    border-color: #2ecc71; 
    opacity: 0.6; 
  }
  
  .day-label { display: block; font-size: 12px; margin-bottom: 8px; color: #888; font-family: sans-serif; }
  .day-icon { font-size: 28px; margin-bottom: 5px; display: block; }
  .day-reward { font-size: 11px; color: #ffd700; font-weight: bold; }

  /* D·∫•u t√≠ch xanh khi ƒë√£ nh·∫≠n */
  .claimed-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); border-radius: 6px;
    display: flex; justify-content: center; align-items: center;
    color: #2ecc71; font-size: 24px; font-weight: bold;
  }

  /* N√∫t b·∫•m */
  .quest-btn {
    background: linear-gradient(45deg, #b8860b, #ffd700); 
    border: none; color: #000;
    padding: 15px 50px; font-size: 16px; font-weight: bold; cursor: pointer;
    text-transform: uppercase; 
    clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
    transition: 0.3s; margin-bottom: 5px;
    font-family: 'Cinzel', serif;
  }
  .quest-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
  .quest-btn:disabled { 
    background: #333; color: #777; cursor: not-allowed; transform: none; box-shadow: none;
  }

  #next-claim-timer { font-size: 12px; color: #aaa; font-family: monospace; }

  /* Modal Popup */
  .rpg-modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); z-index: 99999;
    justify-content: center; align-items: center;
  }
  .rpg-modal-content {
    background: #151515; border: 2px solid #ffd700; 
    padding: 40px; text-align: center; border-radius: 12px; 
    max-width: 400px; width: 90%;
    box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
    animation: popIn 0.3s ease-out;
  }
  @keyframes popIn { from {transform: scale(0.5); opacity:0;} to {transform: scale(1); opacity:1;} }

  .modal-title { color: #ffd700; margin-top: 0; font-size: 1.8rem; }
  .modal-icon { font-size: 80px; margin: 20px 0; animation: float 3s infinite ease-in-out; }
  @keyframes float { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }
  
  .modal-msg { font-size: 1.1rem; line-height: 1.5; color: #eee; }
  
  .code-box {
    display: none; margin-top: 20px; 
    background: #222; padding: 15px; 
    color: #2ecc71; font-weight: bold; font-size: 1.2rem; letter-spacing: 2px; 
    border: 1px dashed #555; cursor: pointer;
  }
  .code-box:hover { background: #333; border-color: #fff; }

  .modal-btn {
    margin-top: 25px; background: #ffd700; color: #000; border: none; 
    padding: 12px 30px; font-weight: bold; cursor: pointer; font-size: 1rem;
  }
</style>

<!-- ========================================== -->
<!-- PH·∫¶N 3: JAVASCRIPT (LOGIC) -->
<!-- ========================================== -->
<script>
  /* --- C·∫§U H√åNH PH·∫¶N TH∆Ø·ªûng --- */
  const REWARD_CONFIG = [
    { day: 1, icon: 'üí∞', label: '+50 AP', type: 'ap', value: 50 },
    { day: 2, icon: 'üí∞', label: '+100 AP', type: 'ap', value: 100 },
    { day: 3, icon: 'üß™', label: '+150 AP', type: 'ap', value: 150 },
    { day: 4, icon: 'üí∞', label: '+200 AP', type: 'ap', value: 200 },
    { day: 5, icon: 'üõ°Ô∏è', label: '+300 AP', type: 'ap', value: 300 },
    { day: 6, icon: 'üíé', label: '+400 AP', type: 'ap', value: 400 },
    // NG√ÄY 7: PH·∫¶N TH∆Ø·ªûng L·ªöN
    { day: 7, icon: 'üëë', label: '+1000 AP', type: 'ap', value: 1000 } 
  ];

  const STORAGE_KEY_DAY = 'rpg_current_day';
  const STORAGE_KEY_TIME = 'rpg_last_claim_time';
  const STORAGE_KEY_GOLD = 'rpg_local_gold';

  document.addEventListener("DOMContentLoaded", function() {
    renderGrid();
    checkStatus();
    
    // C·∫≠p nh·∫≠t b·ªô ƒë·∫øm th·ªùi gian m·ªói gi√¢y
    setInterval(checkStatus, 1000);
  });

  // 1. V·∫Ω giao di·ªán l∆∞·ªõi
  function renderGrid() {
    const grid = document.getElementById('quest-grid');
    // L·∫•y ng√†y hi·ªán t·∫°i, m·∫∑c ƒë·ªãnh l√† 1
    const currentDay = parseInt(localStorage.getItem(STORAGE_KEY_DAY) || 1);
    
    grid.innerHTML = '';
    
    REWARD_CONFIG.forEach(r => {
      let statusClass = 'locked';
      let checkMark = '';

      if (r.day < currentDay) {
        statusClass = 'claimed';
        checkMark = '<div class="claimed-overlay">‚úì</div>';
      } else if (r.day === currentDay) {
        statusClass = 'active';
      }
      
      grid.innerHTML += `
        <div class="day-card ${statusClass}">
          <span class="day-label">Day ${r.day}</span>
          <div class="day-icon">${r.icon}</div>
          <span class="day-reward">${r.label}</span>
          ${checkMark}
        </div>
      `;
    });
  }

  // 2. Ki·ªÉm tra tr·∫°ng th√°i n√∫t b·∫•m (Cooldown)
  function checkStatus() {
    const btn = document.getElementById('quest-claim-btn');
    const timerTxt = document.getElementById('next-claim-timer');
    const lastTime = parseInt(localStorage.getItem(STORAGE_KEY_TIME) || 0);
    const now = new Date().getTime();
    
    // --- CH·∫æ ƒê·ªò TEST: 10 GI√ÇY ---
    // (Khi ch·∫°y th·∫≠t s·ª≠a 10000 th√†nh 86400000)
    const COOLDOWN = 10000; 

    const diff = now - lastTime;

    if (diff < COOLDOWN) {
      // ƒêang ch·ªù
      btn.innerText = "H√ÉY QUAY L·∫†I SAU";
      btn.disabled = true;
      btn.style.opacity = "0.5";
      
      // T√≠nh to√°n th·ªùi gian c√≤n l·∫°i
      const remaining = COOLDOWN - diff;
      const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
      
      timerTxt.innerText = `Ch·ªù: ${hours}h ${minutes}p ${seconds}s ƒë·ªÉ nh·∫≠n qu√† ti·∫øp theo`;
    } else {
      // ƒê∆∞·ª£c nh·∫≠n
      btn.innerText = "TRI·ªÜU H·ªíI QU√Ä";
      btn.disabled = false;
      btn.style.opacity = "1";
      timerTxt.innerText = "Ph·∫ßn th∆∞·ªüng ƒë√£ s·∫µn s√†ng!";
    }
  }

  // 3. X·ª≠ l√Ω khi b·∫•m n√∫t nh·∫≠n qu√†
  function claimDailyReward() {
    let currentDay = parseInt(localStorage.getItem(STORAGE_KEY_DAY) || 1);
    
    // An to√†n: Reset v·ªÅ 1 n·∫øu d·ªØ li·ªáu l·ªói > 7
    if (currentDay > 7) currentDay = 1;

    const reward = REWARD_CONFIG[currentDay - 1];
    const now = new Date().getTime();

    // -- HI·ªÜN POPUP --
    const modal = document.getElementById('reward-modal');
    const icon = document.getElementById('reward-icon');
    const msg = document.getElementById('reward-msg');
    const codeBox = document.getElementById('reward-code-box');
    const codeText = document.getElementById('giftcode-text');

    modal.style.display = 'flex';
    icon.innerText = reward.icon;
    codeBox.style.display = 'none';

    if (reward.type === 'ap') {
      // Logic c·ªông ƒëi·ªÉm AP
      let currentAP = parseInt(localStorage.getItem('rpg_activity_points') || 0);
      let newAP = currentAP + reward.value;
      localStorage.setItem('rpg_activity_points', newAP);
      
      msg.innerHTML = `B·∫°n nh·∫≠n ƒë∆∞·ª£c <b style="color:#a335ee; font-size:1.5em;">+${reward.value} AP</b>`;
      
      // Update HUD n·∫øu c√≥
      const hudAP = document.getElementById('hud-ap-display');
      if (hudAP) {
        hudAP.innerText = newAP + ' AP üõí';
        hudAP.style.display = 'block';
      }
      
    } else if (reward.type === 'gold') {
      // Logic c·ªông v√†ng ·∫£o (gi·ªØ l·∫°i n·∫øu c·∫ßn)
      let currentGold = parseInt(localStorage.getItem(STORAGE_KEY_GOLD) || 0);
      let newGold = currentGold + reward.value;
      localStorage.setItem(STORAGE_KEY_GOLD, newGold);
      
      msg.innerHTML = `B·∫°n nh·∫≠n ƒë∆∞·ª£c <b style="color:#ffd700; font-size:1.5em;">${reward.value} GOLD</b>`;
      
    } else if (reward.type === 'code') {
      // Logic hi·ªán Giftcode (gi·ªØ l·∫°i n·∫øu c·∫ßn)
      msg.innerText = "Tuy·ªát v·ªùi! B·∫°n nh·∫≠n ƒë∆∞·ª£c M√£ Gi·∫£m Gi√° ƒê·∫∑c Bi·ªát:";
      codeBox.style.display = 'block';
      codeText.innerText = reward.value;
    } else {
      // V·∫≠t ph·∫©m th∆∞·ªùng
      msg.innerText = `B·∫°n nh·∫≠n ƒë∆∞·ª£c v·∫≠t ph·∫©m: ${reward.value}`;
    }

    // -- L∆ØU D·ªÆ LI·ªÜU --
    localStorage.setItem(STORAGE_KEY_TIME, now);
    
    // TƒÉng ng√†y cho l·∫ßn sau
    if (currentDay < 7) {
      localStorage.setItem(STORAGE_KEY_DAY, currentDay + 1);
    } else {
      // H·∫øt v√≤ng l·∫∑p 7 ng√†y -> Reset v·ªÅ ng√†y 1
      localStorage.setItem(STORAGE_KEY_DAY, 1); 
    }

    // C·∫≠p nh·∫≠t giao di·ªán
    renderGrid();
    checkStatus();
  }

  // 4. C√°c h√†m ti·ªán √≠ch
  function closeRewardModal() {
    document.getElementById('reward-modal').style.display = 'none';
  }

  function copyGiftCode() {
    const text = document.getElementById('giftcode-text').innerText;
    navigator.clipboard.writeText(text);
    alert("ƒê√£ copy m√£: " + text + "\nH√£y d√πng n√≥ khi thanh to√°n!");
  }
</script>

<!-- ========================================== -->
<!-- PH·∫¶N 4: SCHEMA SHOPIFY -->
<!-- ========================================== -->
{% schema %}
{
  "name": "BSA Daily Quest V3",
  "settings": [
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "·∫¢nh n·ªÅn Khung Quest"
    }
  ],
  "presets": [
    {
      "name": "BSA Daily Quest V3",
      "category": "Gamification"
    }
  ]
}
{% endschema %}