{% comment %}
  LOOTBOX THANK YOU PAGE HANDLER
  Place this snippet in checkout additional scripts or thank you page
  When customer completes lootbox payment, automatically add to inventory
{% endcomment %}

{% if checkout %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Check line items in order
    {% for line_item in checkout.line_items %}
      {% if line_item.properties['_is_lootbox'] == 'true' %}
        // This is a lootbox - add to inventory
        (function() {
          const lootboxData = {
            name: "{{ line_item.title | escape }}",
            image: "{{ line_item.properties['_product_image'] | default: line_item.image | image_url: width: 500 }}",
            variantId: {{ line_item.variant_id }},
            lootTable: {{ line_item.properties['_loot_table'] | default: '[]' }}
          };
          
          // Get current inventory
          let inventory = JSON.parse(localStorage.getItem('rpg_inventory') || '[]');
          
          // Add new lootbox (quantity based on line item)
          for (let i = 0; i < {{ line_item.quantity }}; i++) {
            inventory.push({
              id: Date.now() + i,
              name: lootboxData.name,
              image: lootboxData.image,
              variantId: lootboxData.variantId,
              lootTable: lootboxData.lootTable,
              addedAt: new Date().toISOString(),
              orderId: "{{ checkout.order_id }}"
            });
          }
          
          // Save to storage
          localStorage.setItem('rpg_inventory', JSON.stringify(inventory));
          
          console.log('âœ… Lootbox added to inventory:', lootboxData.name);
        })();
      {% endif %}
    {% endfor %}
  });
</script>
{% endif %}
